<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆ‘çš„æ¡£æ¡ˆ - é»‘çˆªä¼šè®®å®¤</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/profile.css" />
</head>

<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" id="themeToggle">ğŸŒ™</button>

    <!-- å†…å®¹åŒº -->
    <div class="profile-container" id="profileContainer">
        <div class="loading">æ­£åœ¨åŠ è½½ä½ çš„æ¡£æ¡ˆ...</div>
    </div>

    <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
    <div class="logout-section">
        <button id="logoutBtn" class="logout-btn">é€€å‡ºç™»å½•</button>
    </div>
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="fixed-bottom-nav">
        <a href="/news.html" class="nav-tab">
            <div>é»‘çˆªåŠ¨æ€</div>
        </a>
        <a href="./main.html" class="nav-tab">
            <div>ä¸»é¡µ</div>
        </a>
        <a href="/profile.html" class="nav-tab active">
            <div>æˆ‘çš„</div>
        </a>
    </div>

    <script>

        function showTemporaryTip(message, duration = 2500) {
            // é˜²æ­¢é‡å¤åˆ›å»º
            let tip = document.getElementById('temporary-tip');
            if (!tip) {
                tip = document.createElement('div');
                tip.id = 'temporary-tip';
                tip.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        `;
                document.body.appendChild(tip);
            }

            tip.textContent = message;
            tip.style.opacity = '1';

            setTimeout(() => {
                tip.style.opacity = '0';
                setTimeout(() => {
                    if (tip.parentNode) tip.parentNode.removeChild(tip);
                }, 200);
            }, duration);
        }
        // ========== å·¥å…·å‡½æ•° ==========
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                try {
                    return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
        }

        // ========== èº«ä»½éªŒè¯ ==========
        async function verifyAuth() {
            const auth = getCookie('auth');
            if (!auth || !auth.battletag) {
                deleteCookie('auth');
                window.location.href = './';
                return null;
            }
            return auth.battletag;
        }

        // è‹±é›„æ•°æ®ï¼ˆç•¥ï¼Œä¿æŒåŸæ ·ï¼‰
        const heroesData = [
            { en: 'doomfist', zh: 'æœ«æ—¥é“æ‹³', role: 'tank', position: 'é‡è£…' },
            { en: 'sigma', zh: 'è¥¿æ ¼ç›', role: 'tank', position: 'é‡è£…' },
            { en: 'orisa', zh: 'å¥¥ä¸½è', role: 'tank', position: 'é‡è£…' },
            { en: 'ramattra', zh: 'æ‹‰ç›åˆ¹', role: 'tank', position: 'é‡è£…' },
            { en: 'reinhardt', zh: 'è±å› å“ˆç‰¹', role: 'tank', position: 'é‡è£…' },
            { en: 'roadhog', zh: 'è·¯éœ¸', role: 'tank', position: 'é‡è£…' },
            { en: 'winston', zh: 'æ¸©æ–¯é¡¿', role: 'tank', position: 'é‡è£…' },
            { en: 'wrecking-ball', zh: 'ç ´åçƒ', role: 'tank', position: 'é‡è£…' },
            { en: 'zarya', zh: 'æŸ¥è‰å¨…', role: 'tank', position: 'é‡è£…' },
            { en: 'dva', zh: 'D.Va', role: 'tank', position: 'é‡è£…' },
            { en: 'junker-queen', zh: 'æ¸£å®¢å¥³ç‹', role: 'tank', position: 'é‡è£…' },
            { en: 'mauga', zh: 'æ¯›åŠ ', role: 'tank', position: 'é‡è£…' },
            { en: 'hazard', zh: 'éª‡ç¾', role: 'tank', position: 'é‡è£…' },
            { en: 'freja', zh: 'å¼—è•¾é›…', role: 'tank', position: 'é‡è£…' },

            { en: 'cassidy', zh: 'å¡è¥¿è¿ª', role: 'damage', position: 'è¾“å‡º' },
            { en: 'genji', zh: 'æºæ°', role: 'damage', position: 'è¾“å‡º' },
            { en: 'pharah', zh: 'æ³•è€ä¹‹é¹°', role: 'damage', position: 'è¾“å‡º' },
            { en: 'reaper', zh: 'æ­»ç¥', role: 'damage', position: 'è¾“å‡º' },
            { en: 'soldier-76', zh: 'å£«å…µï¼š76', role: 'damage', position: 'è¾“å‡º' },
            { en: 'sombra', zh: 'é»‘å½±', role: 'damage', position: 'è¾“å‡º' },
            { en: 'tracer', zh: 'çŒç©º', role: 'damage', position: 'è¾“å‡º' },
            { en: 'bastion', zh: 'å ¡å’', role: 'damage', position: 'è¾“å‡º' },
            { en: 'hanzo', zh: 'åŠè—', role: 'damage', position: 'è¾“å‡º' },
            { en: 'junkrat', zh: 'ç‹‚é¼ ', role: 'damage', position: 'è¾“å‡º' },
            { en: 'mei', zh: 'ç¾', role: 'damage', position: 'è¾“å‡º' },
            { en: 'torbjorn', zh: 'æ‰˜æ¯”æ˜‚', role: 'damage', position: 'è¾“å‡º' },
            { en: 'widowmaker', zh: 'é»‘ç™¾åˆ', role: 'damage', position: 'è¾“å‡º' },
            { en: 'ashe', zh: 'è‰¾ä»€', role: 'damage', position: 'è¾“å‡º' },
            { en: 'echo', zh: 'å›å£°', role: 'damage', position: 'è¾“å‡º' },
            { en: 'sojourn', zh: 'ç´¢æ°æ©', role: 'damage', position: 'è¾“å‡º' },
            { en: 'symmetra', zh: 'ç§©åºä¹‹å…‰', role: 'damage', position: 'è¾“å‡º' },
            { en: 'juno', zh: 'æœ±è¯º', role: 'damage', position: 'è¾“å‡º' },
            { en: 'wuyang', zh: 'æ— æ¼¾', role: 'damage', position: 'è¾“å‡º' },
            { en: 'venture', zh: 'æ¢å¥‡', role: 'damage', position: 'è¾“å‡º' },

            { en: 'ana', zh: 'å®‰å¨œ', role: 'support', position: 'æ”¯æ´' },
            { en: 'baptiste', zh: 'å·´è’‚æ–¯ç‰¹', role: 'support', position: 'æ”¯æ´' },
            { en: 'brigitte', zh: 'å¸ƒä¸½å‰å¡”', role: 'support', position: 'æ”¯æ´' },
            { en: 'lucio', zh: 'å¢è¥¿å¥¥', role: 'support', position: 'æ”¯æ´' },
            { en: 'mercy', zh: 'å¤©ä½¿', role: 'support', position: 'æ”¯æ´' },
            { en: 'moira', zh: 'è«ä¼Šæ‹‰', role: 'support', position: 'æ”¯æ´' },
            { en: 'zenyatta', zh: 'ç¦…é›…å¡”', role: 'support', position: 'æ”¯æ´' },
            { en: 'kiriko', zh: 'é›¾å­', role: 'support', position: 'æ”¯æ´' },
            { en: 'lifeweaver', zh: 'ç”Ÿå‘½ä¹‹æ¢­', role: 'support', position: 'æ”¯æ´' },
            { en: 'illari', zh: 'ä¼Šæ‹‰é”', role: 'support', position: 'æ”¯æ´' }
        ];

        // ========== æ®µä½æ•°æ® ==========
        const ranksData = [
            { key: 'silver', name: 'ç™½é“¶' },
            { key: 'gold', name: 'é»„é‡‘' },
            { key: 'diamond', name: 'é’»çŸ³' },
            { key: 'master', name: 'å¤§å¸ˆ' },
            { key: 'grandmaster', name: 'å®—å¸ˆ' }
        ];

        let currentRank = null; // { rank: 'gold', level: 2 } æˆ– null

        let currentHeroList = [];
        let originalHeroList = [];
        let isEditing = false;
        let battletag = '';
        let fullUserData = null; // ç”¨äºç¼“å­˜ä»æœåŠ¡å™¨åŠ è½½çš„å®Œæ•´ç”¨æˆ·æ¡£æ¡ˆ

        async function renderProfile(tag) {
            battletag = tag;
            const container = document.getElementById('profileContainer');
            const encodedTag = encodeURIComponent(tag);
            const avatarPath = `./imge/${encodedTag}.jpg`;

            const greetings = [
                'åˆ«æ¥æ— æ™~', 'å¥½ä¹…ä¸è§ï¼', 'æ¬¢è¿ä½ ï¼Œç‰¹å·¥', 'è¿‘æ¥å¯å¥½ï¼Ÿ', 'ä»Šå¤©å¤©æ°”ä¸é”™',
                'é»‘çˆªéœ€è¦ä½ ', 'åˆè§é¢äº†ï¼', 'ä»»åŠ¡é¡ºåˆ©å—ï¼Ÿ', 'ä¸€åˆ‡å®‰å¥½ï¼Ÿ'
            ];
            const greeting = greetings[Math.floor(Math.random() * greetings.length)];

            let userData = null;
            let isPendingSubmission = false;

            // Step 1: ä¼˜å…ˆå°è¯•ä» talon-public åŠ è½½ï¼ˆç”¨æˆ·æäº¤ä½†æœªå®¡æ ¸ï¼‰
            try {
                const publicRes = await fetch(
                    `https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTag}/${encodedTag}.json?t=${Date.now()}`
                );
                if (publicRes.ok) {
                    userData = await publicRes.json();
                    isPendingSubmission = true;
                }
            } catch (err) {
                console.warn('Public config not found or failed to load:', err);
            }

            // Step 2: å¦‚æœ public æ²¡æœ‰ï¼Œåˆ™å›é€€åˆ° talon-adminï¼ˆå·²å®¡æ ¸ï¼‰
            if (!userData) {
                try {
                    const adminRes = await fetch(
                        `https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTag}/${encodedTag}.json?t=${Date.now()}`
                    );
                    if (!adminRes.ok) throw new Error('Admin data not found');
                    userData = await adminRes.json();
                } catch (err) {
                    console.error('Failed to load both public and admin profile:', err);
                    container.innerHTML = `<div class="error">âš ï¸ æ— æ³•åŠ è½½ä½ çš„æ¡£æ¡ˆ<br>è¯·ç¡®è®¤è´¦å·å·²æ³¨å†Œ</div>`;
                    return;
                }
            }

            // âœ… å…³é”®ï¼šç¼“å­˜å®Œæ•´ç”¨æˆ·æ•°æ®
            fullUserData = userData;

            // Step 3: å¤„ç†è‹±é›„åˆ—è¡¨
            currentHeroList = (userData.hero && Array.isArray(userData.hero)) ? userData.hero.slice(0, 5) : [];
            while (currentHeroList.length < 5) currentHeroList.push(null);
            originalHeroList = [...currentHeroList];

            // Step 4: å¤„ç†æ®µä½æ•°æ®
            currentRank = userData.Rank || null;

            // Step 5: æ¸²æŸ“ UI
            let statusNotice = '';
            if (isPendingSubmission) {
                statusNotice = '<div class="pending-notice">å­˜åœ¨å¾…ç®¡ç†å‘˜ Node éªŒè¯çš„æäº¤ï¼Œåœ¨å¿«é©¬åŠ é­å•¦~</div>';
            }



            // æ„å»ºæ®µä½æ˜¾ç¤º HTML
            let rankDisplayHTML = '';
            if (currentRank && currentRank.rank && typeof currentRank.level === 'number') {
                const rankInfo = ranksData.find(r => r.key === currentRank.rank);
                if (rankInfo) {
                    rankDisplayHTML = `
            <div class="profile-rank" id="profileRank">
                <img src="./imge/rank/${currentRank.rank}.png" alt="${rankInfo.name}" />
                <span class="rank-level">${currentRank.level}</span>
            </div>
        `;
                } else {
                    rankDisplayHTML = '<div class="profile-rank empty-rank" id="profileRank">+</div>';
                }
            } else {
                rankDisplayHTML = '<div class="profile-rank empty-rank" id="profileRank">+</div>';
            }
            container.innerHTML = `
        <img src="${avatarPath}" alt="${tag}" class="profile-avatar" onerror="this.style.opacity='0.5'" />
        <div class="profile-greeting">${greeting}</div>
        <div class="profile-id">${tag}</div>
        ${statusNotice}
        ${rankDisplayHTML}
        <div class="hero-edit-wrapper">
            <div class="profile-heroes" id="profileHeroes"></div>
            <button class="edit-btn" id="editBtn">âœ ç¼–è¾‘</button>
        </div>
        <div class="edit-actions" id="editActions" style="display:none;">
            <button class="btn-save">ğŸ’¾ ä¿å­˜</button>
            <button class="btn-cancel">âŒ å–æ¶ˆ</button>
        </div>
    `;

            bindRankClick();
            renderHeroesUI();
            bindEditEvents();
        }

        function renderHeroesUI() {
            const heroContainer = document.getElementById('profileHeroes');
            if (!heroContainer) return;

            heroContainer.innerHTML = '';
            currentHeroList.forEach((heroKey, index) => {
                const item = document.createElement('div');
                item.className = 'hero-slot';
                item.dataset.index = index;

                if (heroKey) {
                    item.innerHTML = `
                <div class="profile-hero-icon">
                    <img src="https://ow.mapleqaq.top/hero/${encodeURIComponent(heroKey)}.png" alt="${heroKey}" loading="lazy" />
                    <button class="remove-hero" style="display:none;">âœ•</button>
                </div>
            `;
                } else {
                    item.innerHTML = `
                <div class="empty-slot" data-index="${index}">
                    <span>+</span>
                </div>
            `;
                }
                heroContainer.appendChild(item);
            });
        }

        function bindEditEvents() {
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.querySelector('.btn-save');
            const cancelBtn = document.querySelector('.btn-cancel');
            const heroContainer = document.getElementById('profileHeroes');

            editBtn.onclick = () => {
                isEditing = true;
                document.querySelectorAll('.remove-hero').forEach(btn => btn.style.display = 'block');
                document.getElementById('editActions').style.display = 'flex';
                editBtn.style.display = 'none';
                updateRankDisplay();
            };

            cancelBtn.onclick = async () => {
                // å…ˆé€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œç¡®ä¿ isEditing = false
                exitEditMode(); // ğŸ‘ˆ æå‰è°ƒç”¨ï¼

                // å†å›æ»šæ•°æ®
                if (fullUserData) {
                    currentHeroList = (fullUserData.hero && Array.isArray(fullUserData.hero))
                        ? fullUserData.hero.slice(0, 5)
                        : [];
                    while (currentHeroList.length < 5) currentHeroList.push(null);
                    originalHeroList = [...currentHeroList];

                    currentRank = fullUserData.Rank || null;
                } else {
                    currentHeroList = [null, null, null, null, null];
                    originalHeroList = [...currentHeroList];
                    currentRank = null;
                }

                // æœ€åæ›´æ–° UIï¼ˆæ­¤æ—¶ isEditing å·²ä¸º falseï¼Œä¸ä¼šæ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼‰
                renderHeroesUI();
                updateRankDisplay();
            };

            saveBtn.onclick = async () => {
                await handleSave();
                // æ›´æ–°æ®µä½ï¼ˆå¦‚æœå·²è®¾ç½®ï¼‰
                if (currentRank && currentRank.rank && typeof currentRank.level === 'number') {
                    updatedData.Rank = { rank: currentRank.rank, level: currentRank.level };
                } else {
                    delete updatedData.Rank; // æˆ–è®¾ä¸º nullï¼Œæ ¹æ®åç«¯çº¦å®š
                }
            };

            heroContainer.onclick = (e) => {
                const emptySlot = e.target.closest('.empty-slot');
                if (emptySlot) {
                    if (!isEditing) {
                        // æ˜¾ç¤ºæç¤º
                        showTemporaryTip('è¯·å…ˆç‚¹å‡»å·¦ä¸Šè§’ç¼–è¾‘æŒ‰é’®', 2500);
                        return;
                    }

                    const slot = emptySlot.closest('.hero-slot');
                    const index = parseInt(slot.dataset.index);
                    showHeroPickerByIndex(index);
                    return;
                }

                if (!isEditing) return;

                if (e.target.classList.contains('remove-hero')) {
                    const slot = e.target.closest('.hero-slot');
                    const index = parseInt(slot.dataset.index);
                    currentHeroList[index] = null;
                    renderHeroesUI();
                    return;
                }
            };

            // ç»‘å®šæ®µä½ç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼‰
            const rankEl = document.getElementById('profileRank');
            if (rankEl) {
                rankEl.onclick = (e) => {
                    if (!isEditing) return;
                    showRankPicker();
                };
            }


            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-rank')) {
                    if (isEditing) {
                        currentRank = null;
                        updateRankDisplay();
                    }
                }
            });
        }

        async function handleSave() {
            const encodedTag = encodeURIComponent(battletag);
            const cleanHeroes = currentHeroList.filter(h => h !== null);

            if (!fullUserData) {
                alert('âŒ æœªåŠ è½½ç”¨æˆ·æ•°æ®ï¼Œæ— æ³•ä¿å­˜');
                return;
            }

            // âœ… æ­£ç¡®æ·±æ‹·è´å¹¶æ›´æ–° hero å’Œ Rank
            const updatedData = JSON.parse(JSON.stringify(fullUserData));
            updatedData.hero = cleanHeroes;

            // âœ… æ­£ç¡®å¤„ç† Rank å­—æ®µ
            if (currentRank && currentRank.rank && typeof currentRank.level === 'number') {
                updatedData.Rank = { rank: currentRank.rank, level: currentRank.level };
            } else {
                delete updatedData.Rank; // æˆ–è®¾ä¸º undefinedï¼Œä½† delete æ›´å¹²å‡€
            }

            const jsonStr = JSON.stringify(updatedData, null, 2);

            // --- ä»¥ä¸‹ç­¾åå’Œä¸Šä¼ é€»è¾‘ä¿æŒä¸å˜ ---
            const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(jsonStr));
            const fullHashArray = new Uint8Array(hashBuffer);
            const halfHashArray = fullHashArray.slice(0, 16);
            const fileHash = Array.from(halfHashArray).map(b => b.toString(16).padStart(2, '0')).join('');

            console.log('File SHA-256:', fileHash);

            try {
                await fetch(`https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTag}/${encodedTag}.json`, {
                    method: 'PUT',
                    body: jsonStr,
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (err) {
                alert('âŒ ä¿å­˜å¤±è´¥ï¼šJSON ä¸Šä¼ å‡ºé”™');
                console.error(err);
                return;
            }

            const auth = getCookie('auth');
            if (!auth || !auth.passwordHash) {
                alert('âŒ Cookie ä¸­ç¼ºå°‘ passwordHash å­—æ®µ');
                return;
            }
            const passwordHash = auth.passwordHash.toLowerCase();

            const timestamp = Date.now();
            const signaturePayload = JSON.stringify({
                ID: battletag,
                F: fileHash,
                T: timestamp,
                P: passwordHash
            });

            const encoder = new TextEncoder();
            const payloadBytes = encoder.encode(signaturePayload);

            if (payloadBytes.length > 190) {
                alert(`âŒ ç­¾åæ•°æ®è¿‡é•¿ï¼ˆ${payloadBytes.length} å­—èŠ‚ï¼‰ï¼Œæœ€å¤§å…è®¸ 190 å­—èŠ‚`);
                console.error('Payload too long:', signaturePayload);
                return;
            }

            const publicKeyPem = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsoywmxv9e4Td4yp9g4bl
KpfQvjBXc+Hp7/I+el7aSzozm1awUXssKoAzXvvI9O2SpZ/1I6qH8lm3+cRmuKfl
nKbwdIWC0njlhJLVuNWWhGFZE3H+sD1Ntmv4F1LARFVe17LcO6GzfmFLFnBYeGnl
wsheIlz6tSqq5pfExMCwkWR5vcltfYi1s1mF+i+69M3YzNOEpzkkXsvWrXSmpncA
eeQ4cVYAxpWQMLbG4ozwxWSo6xLsM9a5TNKAYKVOuJVbBBfNvmbd/7wGbIkV4yPK
Rslt7C0rskkC4qjr+AwYoo+DryivVhnMLnehGiUjcFn7FX4EvZmZb8OCLId8510g
mQIDAQAB
-----END PUBLIC KEY-----`;

            let binaryDer;
            try {
                const pemHeader = "-----BEGIN PUBLIC KEY-----";
                const pemFooter = "-----END PUBLIC KEY-----";
                const pemContents = publicKeyPem
                    .replace(pemHeader, '')
                    .replace(pemFooter, '')
                    .replace(/\s/g, '');
                const binaryDerString = atob(pemContents);
                binaryDer = new Uint8Array(binaryDerString.length);
                for (let i = 0; i < binaryDerString.length; i++) {
                    binaryDer[i] = binaryDerString.charCodeAt(i);
                }
            } catch (e) {
                alert('âŒ å…¬é’¥è§£æå¤±è´¥');
                console.error(e);
                return;
            }

            let publicKey;
            try {
                publicKey = await crypto.subtle.importKey(
                    "spki",
                    binaryDer.buffer,
                    { name: "RSA-OAEP", hash: "SHA-256" },
                    true,
                    ["encrypt"]
                );
            } catch (e) {
                alert('âŒ RSA å…¬é’¥å¯¼å…¥å¤±è´¥ï¼š' + e.message);
                console.error(e);
                return;
            }

            let encrypted;
            try {
                encrypted = await crypto.subtle.encrypt(
                    { name: "RSA-OAEP", hash: "SHA-256" },
                    publicKey,
                    payloadBytes
                );
            } catch (e) {
                alert('âŒ ç­¾ååŠ å¯†å¤±è´¥ï¼š' + e.message);
                console.error(e);
                return;
            }

            const encryptedArray = new Uint8Array(encrypted);
            let binary = '';
            for (let i = 0; i < encryptedArray.length; i++) {
                binary += String.fromCharCode(encryptedArray[i]);
            }
            const signatureBase64 = btoa(binary);

            try {
                await fetch(`https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTag}/push.signature`, {
                    method: 'PUT',
                    body: signatureBase64,
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' }
                });
            } catch (err) {
                alert('âŒ ç­¾åä¸Šä¼ å¤±è´¥');
                console.error(err);
                return;
            }

            alert('âœ… ä¿å­˜æˆåŠŸï¼');
            originalHeroList = [...currentHeroList];
            // âœ… ä¿å­˜åæ›´æ–° fullUserData ç¼“å­˜ï¼Œé¿å…ä¸‹æ¬¡å–æ¶ˆæ—¶ç”¨æ—§æ•°æ®
            fullUserData = updatedData;
            exitEditMode();
        }

        function exitEditMode() {
            isEditing = false;
            document.querySelectorAll('.remove-hero').forEach(btn => btn.style.display = 'none');
            document.getElementById('editActions').style.display = 'none';
            document.getElementById('editBtn').style.display = 'block';
        }

        function showHeroPickerByIndex(index) {
            const usedHeroes = new Set(currentHeroList.filter(h => h));
            const availableHeroes = heroesData.filter(h => !usedHeroes.has(h.en));

            const tankHeroes = availableHeroes.filter(h => h.role === 'tank');
            const damageHeroes = availableHeroes.filter(h => h.role === 'damage');
            const supportHeroes = availableHeroes.filter(h => h.role === 'support');

            const picker = document.createElement('div');
            picker.className = 'hero-picker';
            picker.dataset.index = index;
            picker.innerHTML = '<div class="picker-title">é€‰æ‹©è‹±é›„</div>';

            const groupsContainer = document.createElement('div');
            groupsContainer.className = 'hero-groups';

            if (tankHeroes.length > 0) groupsContainer.appendChild(renderHeroGroup('é‡è£…', tankHeroes));
            if (damageHeroes.length > 0) groupsContainer.appendChild(renderHeroGroup('è¾“å‡º', damageHeroes));
            if (supportHeroes.length > 0) groupsContainer.appendChild(renderHeroGroup('æ”¯æ´', supportHeroes));

            picker.appendChild(groupsContainer);

            const closeBtn = document.createElement('button');
            closeBtn.className = 'picker-close';
            closeBtn.textContent = 'Ã—';
            closeBtn.onclick = () => document.body.removeChild(picker);
            picker.appendChild(closeBtn);

            document.body.appendChild(picker);
        }

        function showRankPicker() {
            // å…ˆç§»é™¤å·²å­˜åœ¨çš„ pickerï¼ˆé˜²æ­¢é‡å¤ï¼‰
            const existing = document.querySelector('.rank-picker');
            if (existing) {
                existing.remove();
                return;
            }

            const picker = document.createElement('div');
            picker.className = 'rank-picker';

            // å¦‚æœå·²é€‰æ®µä½ï¼Œåˆ™è¿›å…¥ç­‰çº§é€‰æ‹©ï¼›å¦åˆ™å…ˆé€‰æ®µä½
            if (currentRank && currentRank.rank) {
                // æ˜¾ç¤ºç­‰çº§é€‰æ‹© (5 â†’ 1)
                picker.innerHTML = '<div class="picker-title">é€‰æ‹©ç­‰çº§</div>';
                const levels = [5, 4, 3, 2, 1];
                const grid = document.createElement('div');
                grid.className = 'rank-level-grid';
                levels.forEach(level => {
                    const btn = document.createElement('button');
                    btn.className = 'rank-level-btn';
                    btn.textContent = level;
                    btn.onclick = () => {
                        currentRank.level = level;
                        updateRankDisplay();
                        picker.remove();
                    };
                    grid.appendChild(btn);
                });
                picker.appendChild(grid);
            } else {
                // æ˜¾ç¤ºæ®µä½é€‰æ‹©
                picker.innerHTML = '<div class="picker-title">é€‰æ‹©æ®µä½</div>';
                const grid = document.createElement('div');
                grid.className = 'rank-grid';
                ranksData.forEach(rank => {
                    const item = document.createElement('div');
                    item.className = 'rank-item';
                    item.innerHTML = `
                <img src="./imge/rank/${rank.key}.png" alt="${rank.name}" />
                <span>${rank.name}</span>
            `;
                    item.onclick = () => {
                        currentRank = { rank: rank.key, level: 5 }; // é»˜è®¤é€‰5çº§
                        // è‡ªåŠ¨è¿›å…¥ç­‰çº§é€‰æ‹©
                        picker.remove();
                        showRankPicker(); // é€’å½’è°ƒç”¨ä»¥åˆ‡æ¢åˆ°ç­‰çº§é€‰æ‹©
                    };
                    grid.appendChild(item);
                });
                picker.appendChild(grid);
            }

            const closeBtn = document.createElement('button');
            closeBtn.className = 'picker-close';
            closeBtn.textContent = 'Ã—';
            closeBtn.onclick = () => picker.remove();
            picker.appendChild(closeBtn);

            document.body.appendChild(picker);
        }

        function updateRankDisplay() {
            const rankEl = document.getElementById('profileRank');
            if (!rankEl) return;

            // æ¸…ç©ºå†…å®¹ï¼ˆä½†ä¿ç•™å®¹å™¨ï¼‰
            rankEl.innerHTML = '';

            if (currentRank && currentRank.rank && typeof currentRank.level === 'number') {
                const rankInfo = ranksData.find(r => r.key === currentRank.rank);
                if (rankInfo) {
                    const img = document.createElement('img');
                    img.src = `./imge/rank/${currentRank.rank}.png`;
                    img.alt = rankInfo.name;
                    rankEl.appendChild(img);

                    const levelSpan = document.createElement('span');
                    levelSpan.className = 'rank-level';
                    levelSpan.textContent = currentRank.level;
                    rankEl.appendChild(levelSpan);

                    // âœ… ä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ·»åŠ åˆ é™¤æŒ‰é’®
                    if (isEditing) {
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-rank';
                        removeBtn.textContent = 'âœ•';
                        removeBtn.style.cssText = `
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    width: 20px;
                    height: 20px;
                    background: #ff4d4d;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    font-size: 12px;
                    cursor: pointer;
                    display: block;
                    z-index: 2;
                `;
                        rankEl.appendChild(removeBtn);
                    }
                } else {
                    rankEl.className = 'profile-rank empty-rank';
                    rankEl.textContent = '+';
                }
            } else {
                rankEl.className = 'profile-rank empty-rank';
                rankEl.textContent = '+';
            }

            // ç¡®ä¿ç±»åæ­£ç¡®ï¼ˆé¿å…è¢«è¦†ç›–ï¼‰
            rankEl.className = currentRank ? 'profile-rank' : 'profile-rank empty-rank';
        }

        function renderHeroGroup(title, heroes) {
            const group = document.createElement('div');
            group.className = 'hero-group';
            const titleEl = document.createElement('div');
            titleEl.className = 'group-title';
            titleEl.textContent = title;
            group.appendChild(titleEl);
            const grid = document.createElement('div');
            grid.className = 'hero-grid';
            heroes.forEach(h => {
                const item = document.createElement('div');
                item.className = 'hero-picker-item';
                item.innerHTML = `
            <img src="https://ow.mapleqaq.top/hero/${encodeURIComponent(h.en)}.png" alt="${h.zh}" />
            <span class="hero-name">${h.zh}</span>
        `;
                item.onclick = (e) => {
                    const picker = e.target.closest('.hero-picker');
                    const targetIndex = parseInt(picker.dataset.index);
                    currentHeroList[targetIndex] = h.en;
                    renderHeroesUI();
                    document.body.removeChild(picker);
                };
                grid.appendChild(item);
            });
            group.appendChild(grid);
            return group;
        }

        function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;
            function updateIcon() {
                const isDark = html.getAttribute('data-theme') === 'dark';
                themeToggle.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            }
            themeToggle.addEventListener('click', () => {
                const current = html.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateIcon();
            });
            const saved = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', saved);
            updateIcon();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initThemeToggle();
            const tag = await verifyAuth();
            if (tag) {
                renderProfile(tag);
            }
        });

        function bindRankClick() {
            const rankEl = document.getElementById('profileRank');
            if (rankEl) {
                // ç§»é™¤å¯èƒ½çš„æ—§ç›‘å¬å™¨ï¼ˆé¿å…é‡å¤ï¼‰
                rankEl.onclick = null;
                rankEl.onclick = () => {
                    if (isEditing) {
                        showRankPicker();
                    }
                };
            }
        }


        // é€€å‡ºç™»å½•åŠŸèƒ½
        document.getElementById('logoutBtn')?.addEventListener('click', () => {
            // æ¸…é™¤æ‰€æœ‰ç›¸å…³ cookieï¼ˆè¿™é‡Œæ¸…é™¤ 'auth' å³å¯ï¼Œå› ä¸ºåªæœ‰å®ƒç”¨äºè®¤è¯ï¼‰
            deleteCookie('auth');

            // å¯é€‰ï¼šæ¸…é™¤å…¶ä»–å¯èƒ½çš„ cookieï¼ˆå¦‚ theme ç­‰ï¼Œä½†é€šå¸¸ä¸éœ€è¦ï¼‰
            // ä¾‹å¦‚ï¼šdeleteCookie('theme');

            // è·³è½¬åˆ°ç½‘ç«™æ ¹ç›®å½•
            window.location.href = './';
        });
    </script>
</body>

</html>
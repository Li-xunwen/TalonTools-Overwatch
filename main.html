<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ˆæœ›å…ˆé”‹é»‘çˆªä¼šè®®å®¤</title>
    <link rel="stylesheet" href="styles/main.css">
</head>

<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" id="themeToggle">ğŸŒ™</button>

    <div class="join-play" id="joinPlayContainer">
        <div class="floating-elements" id="floatingElements"></div>


        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <div class="top-tip-text">è¿™ä¸ªæœªæ¥å€¼å¾—ä¸ºä¹‹å¥‹æˆ˜</div>
            <!-- å¤´å›¾æµ·æŠ¥åŒºåŸŸ -->
            <div class="poster-wrapper">
                <div class="poster-container">
                    <!-- é¡µé¢æœ€é¡¶ç«¯æç¤º -->
                    <div class="play-hero hero1" id="hero1"></div>
                    <div class="play-hero hero2" id="hero2"></div>
                    <div class="play-hero hero3" id="hero3"></div>
                    <div class="play-hero hero4" id="hero4"></div>
                    <div class="play-hero hero5" id="hero5"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æˆå‘˜åå•</h2>
                <div class="members-grid" id="membersGrid">
                    <!-- æˆå‘˜åç‰‡ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æ´»åŠ¨äº®ç‚¹</h2>
                <div class="test-elements-grid">
                    <div class="test-element">ç‰¹è‰²ç©æ³•</div>
                    <div class="test-element">é™å®šçš®è‚¤</div>
                    <div class="test-element">ä¸“å±æˆå°±</div>
                    <div class="test-element">å›¢é˜Ÿç«æŠ€</div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æµ‹è¯•å†…å®¹åŒºåŸŸ</h2>
                <p class="section-content">
                    æ­¤åŒºåŸŸç”¨äºå±•ç¤ºæµ‹è¯•å…ƒç´ å’Œå ä½å†…å®¹ã€‚<br>
                    åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™é‡Œå°†åŒ…å«æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€æ’è¡Œæ¦œã€ç©å®¶ç»Ÿè®¡æ•°æ®ç­‰å†…å®¹ã€‚
                </p>
                <div class="test-elements-grid">
                    <div class="test-element">æ•°æ®ç»Ÿè®¡</div>
                    <div class="test-element">æ’è¡Œæ¦œ</div>
                    <div class="test-element">å¥–åŠ±é¢„è§ˆ</div>
                    <div class="test-element">ç©å®¶ç¤¾åŒº</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ========== èº«ä»½éªŒè¯å®ˆå« ==========
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                try {
                    return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
        }

        async function verifyAuth() {
            const auth = getCookie('auth');
            if (!auth || !auth.battletag || !auth.passwordHash) {
                deleteCookie('auth');
                window.location.href = './';
                return false;
            }

            const { battletag, passwordHash } = auth;
            const expectedPrefix = passwordHash.substring(0, 16).toUpperCase();
            const encodedTag = encodeURIComponent(battletag);
            const url = `https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTag}/${encodedTag}.json?t=${Date.now()}`;

            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error('User data not found');

                const userData = await res.json();
                const serverPwd16 = (userData.PWD16Byte || '').toUpperCase();

                if (expectedPrefix !== serverPwd16) {
                    throw new Error('Password mismatch');
                }

                return true;
            } catch (err) {
                console.warn('èº«ä»½éªŒè¯å¤±è´¥:', err);
                deleteCookie('auth');
                window.location.href = './';
                return false;
            }
        }

        // ========== è¯„ä»·ç›¸å…³é€»è¾‘ ==========
        const evaluationCache = new Map(); // ç¼“å­˜æ¯ä¸ªç”¨æˆ·çš„è¯„ä»·æ•°æ® { username => evaluationArray }
        const pendingEvaluations = new Map(); // è®°å½•å¾…æäº¤çš„è¯„ä»· { targetUser => evaluationText }

        // è·å–æŸç”¨æˆ·çš„è¯„ä»·æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰ï¼Œä¼˜å…ˆä»talon-publicè·å–
        async function fetchEvaluations(username) {
            if (evaluationCache.has(username)) {
                return evaluationCache.get(username);
            }

            const encoded = encodeURIComponent(username);

            // ä¼˜å…ˆä»talon-publicè·å–
            let url = `https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/${encoded}/evaluation.json?t=${Date.now()}`;
            let res;
            try {
                res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) {
                    throw new Error('Public evaluation not found');
                }
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error('Invalid format');
                evaluationCache.set(username, data);
                return data;
            } catch (err) {
                console.warn(`Failed to load public evaluations for ${username}, trying admin:`, err);
            }

            // å¦‚æœpublicè·å–å¤±è´¥ï¼Œå°è¯•ä»talon-adminè·å–
            url = `https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/${encoded}/evaluation.json?t=${Date.now()}`;
            try {
                res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) {
                    if (res.status === 404) {
                        evaluationCache.set(username, []);
                        return [];
                    }
                    throw new Error('Network error');
                }
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error('Invalid format');
                evaluationCache.set(username, data);
                return data;
            } catch (err) {
                console.warn(`Failed to load admin evaluations for ${username}:`, err);
                evaluationCache.set(username, []);
                return [];
            }
        }

        // æäº¤è¯„ä»·å˜æ›´
        async function submitEvaluation(targetUser, evaluationText) {
            const selfTag = getCookie('auth')?.battletag;
            if (!selfTag) return;

            const encodedSelf = encodeURIComponent(selfTag);
            const encodedTarget = encodeURIComponent(targetUser);
            const url = `https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTarget}/evaluation.json`;

            let currentEvaluations = await fetchEvaluations(targetUser);
            currentEvaluations = [...currentEvaluations]; // clone

            // æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å½“å‰ç”¨æˆ·çš„è¯„ä»·
            const existingIndex = currentEvaluations.findIndex(item => item.ID === selfTag);

            if (evaluationText.trim() !== '') {
                // æ›´æ–°æˆ–æ·»åŠ è¯„ä»·
                if (existingIndex >= 0) {
                    currentEvaluations[existingIndex].evaluation = evaluationText.trim();
                } else {
                    currentEvaluations.push({ ID: selfTag, evaluation: evaluationText.trim() });
                }
            } else {
                // åˆ é™¤è¯„ä»·
                if (existingIndex >= 0) {
                    currentEvaluations.splice(existingIndex, 1);
                }
            }

            try {
                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentEvaluations)
                });

                if (!putRes.ok) throw new Error('PUT failed');

                // æ›´æ–°ç¼“å­˜
                evaluationCache.set(targetUser, currentEvaluations);
                pendingEvaluations.delete(targetUser);
                console.log(`âœ… æˆåŠŸæäº¤è¯„ä»·ç»™ ${targetUser}`);

                // ç”Ÿæˆç­¾åæ–‡ä»¶
                await generateEvaluationSignature(encodedTarget, currentEvaluations);

                // æ›´æ–°è¯„ä»·æ˜¾ç¤º
                updateEvaluationDisplay(targetUser);

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                alert('è¯„ä»·æäº¤æˆåŠŸï¼');

                // é‡æ–°æ¸²æŸ“è¯„ä»·åˆ—è¡¨ä»¥æ›´æ–°UI
                const grid = document.getElementById('membersGrid');
                if (grid) {
                    const cards = grid.querySelectorAll('.member-card');
                    for (const card of cards) {
                        const idEl = card.querySelector('.member-id');
                        if (idEl && idEl.textContent === targetUser) {
                            renderEvaluationList(card, targetUser);
                            break;
                        }
                    }
                }
            } catch (err) {
                console.error(`âŒ æäº¤è¯„ä»·å¤±è´¥ (${targetUser}):`, err);
                alert('è¯„ä»·æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ç”Ÿæˆè¯„ä»·ç­¾åæ–‡ä»¶
        async function generateEvaluationSignature(encodedTarget, evaluations) {
            const jsonStr = JSON.stringify(evaluations, null, 2);

            const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(jsonStr));
            const fullHashArray = new Uint8Array(hashBuffer);
            const halfHashArray = fullHashArray.slice(0, 16);
            const fileHash = Array.from(halfHashArray).map(b => b.toString(16).padStart(2, '0')).join('');

            const auth = getCookie('auth');
            if (!auth || !auth.passwordHash) {
                console.error('Cookie ä¸­ç¼ºå°‘ passwordHash å­—æ®µ');
                return;
            }
            const passwordHash = auth.passwordHash.toLowerCase();

            const timestamp = Date.now();
            const selfTag = getCookie('auth')?.battletag;
            const signaturePayload = JSON.stringify({
                ID: selfTag,
                F: fileHash,
                T: timestamp,
                P: passwordHash
            });

            const encoder = new TextEncoder();
            const payloadBytes = encoder.encode(signaturePayload);

            if (payloadBytes.length > 190) {
                console.error(`âŒ ç­¾åæ•°æ®è¿‡é•¿ï¼ˆ${payloadBytes.length} å­—èŠ‚ï¼‰ï¼Œæœ€å¤§å…è®¸ 190 å­—èŠ‚`);
                return;
            }

            const publicKeyPem = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsoywmxv9e4Td4yp9g4bl
KpfQvjBXc+Hp7/I+el7aSzozm1awUXssKoAzXvvI9O2SpZ/1I6qH8lm3+cRmuKfl
nKbwdIWC0njlhJLVuNWWhGFZE3H+sD1Ntmv4F1LARFVe17LcO6GzfmFLFnBYeGnl
wsheIlz6tSqq5pfExMCwkWR5vcltfYi1s1mF+i+69M3YzNOEpzkkXsvWrXSmpncA
eeQ4cVYAxpWQMLbG4ozwxWSo6xLsM9a5TNKAYKVOuJVbBBfNvmbd/7wGbIkV4yPK
Rslt7C0rskkC4qjr+AwYoo+DryivVhnMLnehGiUjcFn7FX4EvZmZb8OCLId8510g
mQIDAQAB
-----END PUBLIC KEY-----`;

            let binaryDer;
            try {
                const pemHeader = "-----BEGIN PUBLIC KEY-----";
                const pemFooter = "-----END PUBLIC KEY-----";
                const pemContents = publicKeyPem
                    .replace(pemHeader, '')
                    .replace(pemFooter, '')
                    .replace(/\s/g, '');
                const binaryDerString = atob(pemContents);
                binaryDer = new Uint8Array(binaryDerString.length);
                for (let i = 0; i < binaryDerString.length; i++) {
                    binaryDer[i] = binaryDerString.charCodeAt(i);
                }
            } catch (e) {
                console.error('âŒ å…¬é’¥è§£æå¤±è´¥', e);
                return;
            }

            let publicKey;
            try {
                publicKey = await crypto.subtle.importKey(
                    "spki",
                    binaryDer.buffer,
                    { name: "RSA-OAEP", hash: "SHA-256" },
                    true,
                    ["encrypt"]
                );
            } catch (e) {
                console.error('âŒ RSA å…¬é’¥å¯¼å…¥å¤±è´¥ï¼š' + e.message);
                return;
            }

            let encrypted;
            try {
                encrypted = await crypto.subtle.encrypt(
                    { name: "RSA-OAEP", hash: "SHA-256" },
                    publicKey,
                    payloadBytes
                );
            } catch (e) {
                console.error('âŒ ç­¾ååŠ å¯†å¤±è´¥ï¼š' + e.message);
                return;
            }

            const encryptedArray = new Uint8Array(encrypted);
            let binary = '';
            for (let i = 0; i < encryptedArray.length; i++) {
                binary += String.fromCharCode(encryptedArray[i]);
            }
            const signatureBase64 = btoa(binary);

            try {
                await fetch(`https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTarget}/evaluation.signature`, {
                    method: 'PUT',
                    body: signatureBase64,
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' }
                });
            } catch (err) {
                console.error('âŒ ç­¾åä¸Šä¼ å¤±è´¥', err);
                return;
            }
        }

        // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ‰“å¼€çš„ evaluation-list å®¹å™¨
        let currentOpenEvaluationList = null;

        // å¤„ç†è¯„ä»·ç‚¹å‡»ï¼ˆæ˜¾ç¤ºè¯„ä»·åˆ—è¡¨å’Œè¾“å…¥æ¡†ï¼‰
        function handleEvaluationClick(card, targetUser) {
            // å¦‚æœå½“å‰ç‚¹å‡»çš„å¡ç‰‡å°±æ˜¯å·²æ‰“å¼€çš„è¯„ä»·åˆ—è¡¨ï¼Œåˆ™æ”¶èµ·
            const listContainer = card.querySelector('.evaluation-list');
            if (currentOpenEvaluationList && currentOpenEvaluationList === listContainer && currentOpenEvaluationList.style.display === 'block') {
                currentOpenEvaluationList.style.display = 'none';
                currentOpenEvaluationList = null;
                return;
            }

            // å…³é—­å…¶ä»–å·²æ‰“å¼€çš„åˆ—è¡¨
            if (currentOpenEvaluationList) {
                currentOpenEvaluationList.style.display = 'none';
            }

            renderEvaluationList(card, targetUser);
        }

        async function renderEvaluationList(card, username) {
            const selfTag = getCookie('auth')?.battletag;
            const evaluations = await fetchEvaluations(username);

            // è·å–æˆ–åˆ›å»º .evaluation-list å®¹å™¨
            let listContainer = card.querySelector('.evaluation-list');
            if (!listContainer) {
                listContainer = document.createElement('div');
                listContainer.className = 'evaluation-list';
                Object.assign(listContainer.style, {
                    position: 'absolute',
                    top: '100%',
                    left: '0',
                    right: '0',
                    backgroundColor: 'rgba(0,0,0,0.85)',
                    borderRadius: '0 0 8px 8px',
                    padding: '8px 0',
                    zIndex: '5',
                    display: 'none',
                    maxHeight: '300px',
                    overflowY: 'auto'
                });
                card.style.position = 'relative';
                card.appendChild(listContainer);
            }

            // æ¸…ç©ºå†…å®¹
            listContainer.innerHTML = '';

            // æ˜¾ç¤ºç°æœ‰è¯„ä»·
            if (evaluations.length === 0) {
                listContainer.innerHTML = '<div style="padding:6px;text-align:center;color:#aaa;">æš‚æ— è¯„ä»·</div>';
            } else {
                evaluations.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'evaluation-item';
                    Object.assign(itemEl.style, {
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '4px 12px',
                        borderBottom: '1px solid rgba(255,255,255,0.1)'
                    });

                    // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·è‡ªå·±çš„è¯„ä»·ï¼Œæ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                    if (selfTag && item.ID === selfTag) {
                        itemEl.innerHTML = `
                    <div class="evaluation-item-content">
                        <span class="evaluation-item-id">${item.ID}:</span>
                        <span class="evaluation-item-evaluation" id="eval-${item.ID}">${item.evaluation}</span>
                    </div>
                    <div class="evaluation-actions">
                        <button class="evaluation-edit-btn" data-id="${item.ID}" data-username="${username}">ä¿®æ”¹</button>
                    </div>
                `;
                    } else {
                        // éå½“å‰ç”¨æˆ·è¯„ä»·ï¼Œä¸æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                        itemEl.innerHTML = `
                    <div class="evaluation-item-content">
                        <span class="evaluation-item-id">${item.ID}:</span>
                        <span class="evaluation-item-evaluation">${item.evaluation}</span>
                    </div>
                    <div class="evaluation-actions">
                        <span class="evaluation-read-only">åªè¯»</span>
                    </div>
                `;
                    }
                    listContainer.appendChild(itemEl);
                });
            }

            // æ·»åŠ è¯„ä»·è¾“å…¥æ¡†ï¼ˆä»…å¯¹è‡ªå·±å¯è§ï¼Œä¸”å½“å‰ç”¨æˆ·æ²¡æœ‰è¯„ä»·æ—¶ï¼‰
            if (selfTag) {
                const existingEval = evaluations.find(item => item.ID === selfTag);
                if (!existingEval) {
                    const inputContainer = document.createElement('div');
                    inputContainer.className = 'evaluation-input-container';
                    inputContainer.style.padding = '8px';
                    inputContainer.style.borderTop = '1px solid rgba(255,255,255,0.1)';

                    inputContainer.innerHTML = `
                    <textarea class="evaluation-input" placeholder="è¯·è¾“å…¥è¯„ä»·ï¼ˆæœ€å¤š32å­—ï¼‰" maxlength="32" rows="2"></textarea>
                    <div class="evaluation-input-actions">
                        <button class="evaluation-submit-btn" data-username="${username}">æäº¤</button>
                    </div>
                `;

                    listContainer.appendChild(inputContainer);

                    const input = inputContainer.querySelector('.evaluation-input');
                    const submitBtn = inputContainer.querySelector('.evaluation-submit-btn');

                    submitBtn.addEventListener('click', () => {
                        const evalText = input.value.trim();
                        if (evalText === '') {
                            if (confirm('è¯„ä»·å†…å®¹ä¸ºç©ºï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ')) {
                                submitEvaluation(username, evalText);
                            }
                        } else if (evalText.length > 32) {
                            alert('è¯„ä»·ä¸èƒ½è¶…è¿‡32ä¸ªå­—ç¬¦ï¼');
                        } else {
                            submitEvaluation(username, evalText);
                        }
                    });
                }
            }

            // å…³é”®é€»è¾‘ï¼šå…ˆå…³é—­å½“å‰æ‰“å¼€çš„åˆ—è¡¨ï¼ˆå¦‚æœä¸æ˜¯åŒä¸€ä¸ªï¼‰
            if (currentOpenEvaluationList && currentOpenEvaluationList !== listContainer) {
                currentOpenEvaluationList.style.display = 'none';
            }

            // æ˜¾ç¤ºæ–°åˆ—è¡¨
            listContainer.style.display = 'block';
            currentOpenEvaluationList = listContainer; // æ›´æ–°å½“å‰æ‰“å¼€çš„å¼•ç”¨

            // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç¡®ä¿æ‰€æœ‰ç¼–è¾‘æŒ‰é’®éƒ½èƒ½å“åº”
            if (selfTag) {
                // äº‹ä»¶å§”æ‰˜æ–¹å¼ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
                listContainer.addEventListener('click', function (event) {
                    const editBtn = event.target.closest('.evaluation-edit-btn');
                    if (editBtn) {
                        event.preventDefault();
                        event.stopPropagation();

                        const id = editBtn.getAttribute('data-id');
                        const username = editBtn.getAttribute('data-username');
                        const evalTextElement = document.getElementById(`eval-${id}`);
                        let originalText = evalTextElement.textContent || '';
                        // æ¸…ç†ï¼šç§»é™¤æ¢è¡Œç¬¦ï¼Œå‹ç¼©å¤šä¸ªç©ºæ ¼ä¸ºä¸€ä¸ªï¼Œå¹¶ trim é¦–å°¾
                        originalText = originalText.replace(/[\r\n]+/g, ' ') // æ¢è¡Œè½¬ç©ºæ ¼
                            .replace(/\s+/g, ' ')     // å¤šä¸ªç©ºç™½åˆå¹¶
                            .trim();

                        // è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ XSSï¼ˆè™½ç„¶æ¥æºå¯ä¿¡ï¼Œä½†å¥½ä¹ æƒ¯ï¼‰
                        const escapedText = originalText
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#039;');

                        evalTextElement.innerHTML = `<textarea class="evaluation-edit-input" maxlength="32" rows="2">${escapedText}</textarea>`;
                        // å°†æŒ‰é’®æ›¿æ¢ä¸ºæäº¤å’Œå–æ¶ˆæŒ‰é’®
                        const actionsContainer = editBtn.parentElement;
                        actionsContainer.innerHTML = `
                            <button class="evaluation-update-btn" data-id="${id}" data-username="${username}">æäº¤</button>
                            <button class="evaluation-cancel-btn" data-id="${id}" data-username="${username}">å–æ¶ˆ</button>
                        `;

                        // ç»‘å®šæ›´æ–°æŒ‰é’®äº‹ä»¶
                        const updateBtn = actionsContainer.querySelector('.evaluation-update-btn');
                        updateBtn && updateBtn.addEventListener('click', function () {
                            const newEvalText = evalTextElement.querySelector('.evaluation-edit-input').value.trim();
                            if (newEvalText.length > 32) {
                                alert('è¯„ä»·ä¸èƒ½è¶…è¿‡32ä¸ªå­—ç¬¦ï¼');
                                return;
                            }
                            submitEvaluation(username, newEvalText);
                        });

                        // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
                        const cancelBtn = actionsContainer.querySelector('.evaluation-cancel-btn');
                        cancelBtn && cancelBtn.addEventListener('click', function () {
                            // æ¢å¤åŸæ¥çš„æ˜¾ç¤º
                            evalTextElement.textContent = originalText;
                            actionsContainer.innerHTML = `
                                <button class="evaluation-edit-btn" data-id="${id}" data-username="${username}">ä¿®æ”¹</button>
                            `;
                        });
                    }

                    // å¤„ç†æ›´æ–°æŒ‰é’®ç‚¹å‡»
                    const updateBtn = event.target.closest('.evaluation-update-btn');
                    if (updateBtn) {
                        event.preventDefault();
                        event.stopPropagation();

                        const id = updateBtn.getAttribute('data-id');
                        const username = updateBtn.getAttribute('data-username');
                        const evalTextElement = document.getElementById(`eval-${id}`);
                        const newEvalText = evalTextElement.querySelector('.evaluation-edit-input').value.trim();

                        if (newEvalText.length > 32) {
                            alert('è¯„ä»·ä¸èƒ½è¶…è¿‡32ä¸ªå­—ç¬¦ï¼');
                            return;
                        }
                        submitEvaluation(username, newEvalText);
                    }

                    // å¤„ç†å–æ¶ˆæŒ‰é’®ç‚¹å‡»
                    const cancelBtn = event.target.closest('.evaluation-cancel-btn');
                    if (cancelBtn) {
                        event.preventDefault();
                        event.stopPropagation();

                        const id = cancelBtn.getAttribute('data-id');
                        const username = cancelBtn.getAttribute('data-username');
                        const evalTextElement = document.getElementById(`eval-${id}`);
                        const originalText = evalTextElement.textContent;

                        // æ¢å¤åŸæ¥çš„æ˜¾ç¤º
                        evalTextElement.textContent = originalText;
                        const actionsContainer = cancelBtn.parentElement;
                        actionsContainer.innerHTML = `
                            <button class="evaluation-edit-btn" data-id="${id}" data-username="${username}">ä¿®æ”¹</button>
                        `;
                    }
                });
            }
        }

        // æ›´æ–°è¯„ä»·æ˜¾ç¤º
        function updateEvaluationDisplay(username) {
            // è¿™é‡Œå¯ä»¥æ›´æ–°ç›¸å…³UIï¼Œå¦‚è¯„ä»·æ•°é‡ç­‰
            // æš‚æ—¶ç•™ç©ºï¼Œå¯æ ¹æ®éœ€è¦æ‰©å±•
        }

        // ========== ç‚¹èµç›¸å…³é€»è¾‘ ==========
        const likeCache = new Map(); // ç¼“å­˜æ¯ä¸ªç”¨æˆ·çš„ç‚¹èµæ•°æ® { username => likeArray }
        const pendingLikes = new Map(); // è®°å½•å¾…æäº¤çš„ç‚¹èµå¢é‡ { targetUser => count }
        const likeTimeouts = new Map(); // ç”¨äºå»¶è¿Ÿæäº¤

        // è·å–æŸç”¨æˆ·çš„ç‚¹èµæ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
        async function fetchLikes(username) {
            if (likeCache.has(username)) {
                return likeCache.get(username);
            }

            const encoded = encodeURIComponent(username);
            const url = `https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/like/${encoded}.json?t=${Date.now()}`;

            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) {
                    if (res.status === 404) {
                        likeCache.set(username, []);
                        return [];
                    }
                    throw new Error('Network error');
                }
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error('Invalid format');
                likeCache.set(username, data);
                return data;
            } catch (err) {
                console.warn(`Failed to load likes for ${username}:`, err);
                likeCache.set(username, []);
                return [];
            }
        }

        // è®¡ç®—æ€»èµæ•°ï¼ˆä»ç¼“å­˜å–ï¼‰
        function getTotalLikes(username) {
            const likes = likeCache.get(username) || [];
            return likes.reduce((sum, item) => sum + (item.Like || 0), 0);
        }

        // æ›´æ–°å¡ç‰‡ä¸Šçš„æ€»èµæ•°æ˜¾ç¤ºï¼ˆæ”¯æŒä¸´æ—¶å¢é‡ï¼‰
        const tempLikeIncrements = new Map(); // username => increment (æœªæäº¤ä½†å·²æ˜¾ç¤º)


        // æäº¤ç‚¹èµå˜æ›´
        async function submitLikes(targetUser) {
            const selfTag = getCookie('auth')?.battletag;
            if (!selfTag) return;

            const encodedSelf = encodeURIComponent(selfTag);
            const encodedTarget = encodeURIComponent(targetUser);
            const url = `https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/like/${encodedTarget}.json`;

            let currentLikes = await fetchLikes(targetUser);
            currentLikes = [...currentLikes]; // clone

            const existing = currentLikes.find(item => item.ID === selfTag);
            const addCount = pendingLikes.get(targetUser) || 0;

            if (addCount <= 0) return;

            if (existing) {
                existing.Like += addCount;
            } else {
                currentLikes.push({ ID: selfTag, Like: addCount });
            }

            // æ’åºï¼ˆé«˜åˆ°ä½ï¼‰
            currentLikes.sort((a, b) => b.Like - a.Like);

            try {
                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentLikes)
                });

                if (!putRes.ok) throw new Error('PUT failed');

                // æ›´æ–°ç¼“å­˜
                likeCache.set(targetUser, currentLikes);
                pendingLikes.delete(targetUser);
                console.log(`âœ… æˆåŠŸæäº¤ ${addCount} ä¸ªèµç»™ ${targetUser}`);

                // æäº¤æˆåŠŸååˆ·æ–°å¯¹åº”å¡ç‰‡çš„ç‚¹èµæ•°
                const grid = document.getElementById('membersGrid');
                if (grid) {
                    const cards = grid.querySelectorAll('.member-card');
                    for (const card of cards) {
                        const idEl = card.querySelector('.member-id');
                        if (idEl && idEl.textContent === targetUser) {
                            updateLikeCountDisplay(card, targetUser);
                            break;
                        }
                    }
                }
            } catch (err) {
                console.error(`âŒ æäº¤ç‚¹èµå¤±è´¥ (${targetUser}):`, err);
                alert('ç‚¹èµæäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        const tempSelfLikeMap = new Map(); // username => temporary like count (for self)

        // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ‰“å¼€çš„ like-list å®¹å™¨
        let currentOpenLikeList = null;

        // è§¦å‘ç‚¹èµï¼ˆUI + è®¡æ•°ï¼‰
        function handleLikeClick(card, targetUser, isSelf) {
            // å…³é—­ä»»ä½•å·²æ‰“å¼€çš„è¯„ä»·åˆ—è¡¨
            if (currentOpenEvaluationList) {
                currentOpenEvaluationList.style.display = 'none';
                currentOpenEvaluationList = null;
            }

            const selfTag = getCookie('auth')?.battletag;
            if (!selfTag) return;

            if (isSelf) {
                // å¦‚æœå½“å‰ç‚¹å‡»çš„å¡ç‰‡å°±æ˜¯å·²æ‰“å¼€çš„ç‚¹èµåˆ—è¡¨ï¼Œåˆ™æ”¶èµ·
                const listContainer = card.querySelector('.like-list');
                if (currentOpenLikeList && currentOpenLikeList === listContainer && currentOpenLikeList.style.display === 'block') {
                    currentOpenLikeList.style.display = 'none';
                    currentOpenLikeList = null;
                    return;
                }

                // å…³é—­å…¶ä»–å·²æ‰“å¼€çš„åˆ—è¡¨
                if (currentOpenLikeList) {
                    currentOpenLikeList.style.display = 'none';
                }

                renderLikeList(card, targetUser); // è‡ªå·±ä¹Ÿå…è®¸çœ‹åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
                return;
            }

            // å¢åŠ å¾…æäº¤è®¡æ•°
            const currentPending = pendingLikes.get(targetUser) || 0;
            pendingLikes.set(targetUser, currentPending + 1);

            // è®°å½•è‡ªå·±çš„ä¸´æ—¶ç‚¹èµæ•°ï¼ˆç”¨äº UI åˆ—è¡¨ï¼‰
            const currentTempSelf = tempSelfLikeMap.get(targetUser) || 0;
            tempSelfLikeMap.set(targetUser, currentTempSelf + 1);

            // ç«‹å³æ›´æ–°æ€»èµæ•°æ˜¾ç¤º
            updateLikeCountDisplay(card, targetUser);

            // è®¾ç½®è‡ªåŠ¨æäº¤ï¼ˆé˜²æŠ–ï¼‰
            clearTimeout(likeTimeouts.get(targetUser));
            likeTimeouts.set(targetUser, setTimeout(() => submitLikes(targetUser), 1200));

            // ç‚¹å‡»åå±•å¼€åˆ—è¡¨
            renderLikeList(card, targetUser);
        }


        async function renderLikeList(card, username) {
            const selfTag = getCookie('auth')?.battletag;
            const likes = await fetchLikes(username);
            let displayLikes = [...likes];

            // åˆå¹¶ä¸´æ—¶ç‚¹èµï¼ˆåŒ…æ‹¬åˆšç‚¹çš„ï¼‰
            if (selfTag) {
                const tempSelfLike = tempSelfLikeMap.get(username) || 0;
                if (tempSelfLike > 0) {
                    const existingIndex = displayLikes.findIndex(item => item.ID === selfTag);
                    if (existingIndex >= 0) {
                        displayLikes[existingIndex] = {
                            ...displayLikes[existingIndex],
                            Like: (displayLikes[existingIndex].Like || 0) + tempSelfLike
                        };
                    } else {
                        displayLikes.push({ ID: selfTag, Like: tempSelfLike });
                    }
                }
            }

            // æ’åº
            displayLikes.sort((a, b) => (b.Like || 0) - (a.Like || 0));

            // è·å–æˆ–åˆ›å»º .like-list å®¹å™¨
            let listContainer = card.querySelector('.like-list');
            if (!listContainer) {
                listContainer = document.createElement('div');
                listContainer.className = 'like-list';
                Object.assign(listContainer.style, {
                    position: 'absolute',
                    top: '100%',
                    left: '0',
                    right: '0',
                    backgroundColor: 'rgba(0,0,0,0.85)',
                    borderRadius: '0 0 8px 8px',
                    padding: '8px 0',
                    zIndex: '5',
                    display: 'none',
                    maxHeight: '200px',
                    overflowY: 'auto'
                });
                card.style.position = 'relative';
                card.appendChild(listContainer);
            }

            // æ¸…ç©ºå†…å®¹
            listContainer.innerHTML = '';
            if (displayLikes.length === 0) {
                listContainer.innerHTML = '<div style="padding:6px;text-align:center;color:#aaa;">æš‚æ— ç‚¹èµ</div>';
            } else {
                displayLikes.slice(0, 10).forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'like-item';
                    Object.assign(itemEl.style, {
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '4px 12px',
                        borderBottom: '1px solid rgba(255,255,255,0.1)'
                    });
                    itemEl.innerHTML = `
                <span class="like-item-id">${item.ID}</span>
                <span class="like-item-like">â¤ï¸${item.Like}</span>
            `;
                    listContainer.appendChild(itemEl);
                });
            }

            // å…³é”®é€»è¾‘ï¼šå…ˆå…³é—­å½“å‰æ‰“å¼€çš„åˆ—è¡¨ï¼ˆå¦‚æœä¸æ˜¯åŒä¸€ä¸ªï¼‰
            if (currentOpenLikeList && currentOpenLikeList !== listContainer) {
                currentOpenLikeList.style.display = 'none';
            }

            // æ˜¾ç¤ºæ–°åˆ—è¡¨
            listContainer.style.display = 'block';
            currentOpenLikeList = listContainer; // æ›´æ–°å½“å‰æ‰“å¼€çš„å¼•ç”¨
        }

        // ========== åŸæœ‰é¡µé¢é€»è¾‘ï¼ˆå°è£…ä¸ºå‡½æ•°ï¼‰==========
        const heroesData = [
            { en: 'doomfist', zh: 'æœ«æ—¥é“æ‹³' },
            { en: 'cassidy', zh: 'å¡è¥¿è¿ª' },
            { en: 'genji', zh: 'æºæ°' },
            { en: 'pharah', zh: 'æ³•è€ä¹‹é¹°' },
            { en: 'reaper', zh: 'æ­»ç¥' },
            { en: 'soldier-76', zh: 'å£«å…µï¼š76' },
            { en: 'sombra', zh: 'é»‘å½±' },
            { en: 'tracer', zh: 'çŒç©º' },
            { en: 'bastion', zh: 'å ¡å’' },
            { en: 'hanzo', zh: 'åŠè—' },
            { en: 'junkrat', zh: 'ç‹‚é¼ ' },
            { en: 'mei', zh: 'ç¾' },
            { en: 'torbjorn', zh: 'æ‰˜æ¯”æ˜‚' },
            { en: 'widowmaker', zh: 'é»‘ç™¾åˆ' },
            { en: 'ashe', zh: 'è‰¾ä»€' },
            { en: 'echo', zh: 'å›å£°' },
            { en: 'sojourn', zh: 'ç´¢æ°æ©' },
            { en: 'ana', zh: 'å®‰å¨œ' },
            { en: 'baptiste', zh: 'å·´è’‚æ–¯ç‰¹' },
            { en: 'brigitte', zh: 'å¸ƒä¸½å‰å¡”' },
            { en: 'lucio', zh: 'å¢è¥¿å¥¥' },
            { en: 'mercy', zh: 'å¤©ä½¿' },
            { en: 'moira', zh: 'è«ä¼Šæ‹‰' },
            { en: 'zenyatta', zh: 'ç¦…é›…å¡”' },
            { en: 'kiriko', zh: 'é›¾å­' },
            { en: 'lifeweaver', zh: 'ç”Ÿå‘½ä¹‹æ¢­' },
            { en: 'sigma', zh: 'è¥¿æ ¼ç›' },
            { en: 'orisa', zh: 'å¥¥ä¸½è' },
            { en: 'ramattra', zh: 'æ‹‰ç›åˆ¹' },
            { en: 'reinhardt', zh: 'è±å› å“ˆç‰¹' },
            { en: 'roadhog', zh: 'è·¯éœ¸' },
            { en: 'winston', zh: 'æ¸©æ–¯é¡¿' },
            { en: 'wrecking-ball', zh: 'ç ´åçƒ' },
            { en: 'zarya', zh: 'æŸ¥è‰å¨…' },
            { en: 'dva', zh: 'D.Va' },
            { en: 'junker-queen', zh: 'æ¸£å®¢å¥³ç‹' },
            { en: 'mauga', zh: 'æ¯›åŠ ' },
            { en: 'hazard', zh: 'éª‡ç¾' },
            { en: 'freja', zh: 'å¼—è•¾é›…' },
            { en: 'juno', zh: 'æœ±è¯º' },
            { en: 'wuyang', zh: 'æ— æ¼¾' },
            { en: 'venture', zh: 'æ¢å¥‡' },
            { en: 'symmetra', zh: 'ç§©åºä¹‹å…‰' },
            { en: 'illari', zh: 'ä¼Šæ‹‰é”' }
        ];

        async function initPage() {
            // åˆ›å»ºæµ®åŠ¨è£…é¥°å…ƒç´ 
            const floatingElements = document.getElementById('floatingElements');
            for (let i = 0; i < 20; i++) {
                const element = document.createElement('div');
                element.classList.add('floating-element');
                element.style.left = Math.random() * 100 + '%';
                element.style.top = Math.random() * 100 + '%';
                element.style.width = (Math.random() * 10 + 5) + 'px';
                element.style.height = element.style.width;
                element.style.animationDuration = (Math.random() * 10 + 10) + 's';
                element.style.animationDelay = Math.random() * 5 + 's';
                floatingElements.appendChild(element);
            }

            // è‹±é›„å‘¼å¸åŠ¨ç”»
            const heroes = document.querySelectorAll('.play-hero');
            heroes.forEach(hero => {
                resetHeroPosition(hero);
                setInterval(() => animateHeroBreathing(hero), 2000 + Math.random() * 3000);
            });

            function resetHeroPosition(hero) {
                hero.style.transition = 'transform 0s';
                hero.style.transform = 'translate(0, 0)';
                hero.offsetHeight;
                hero.style.transition = 'transform 3s ease-in-out';
            }

            function animateHeroBreathing(hero) {
                const tx = (Math.random() - 0.5) * 10;
                const ty = (Math.random() - 0.5) * 10;
                hero.style.transform = `translate(${tx}px, ${ty}px)`;
            }

            window.addEventListener('resize', () => {
                setTimeout(() => heroes.forEach(resetHeroPosition), 100);
            });

            // ä¸»é¢˜åˆ‡æ¢é€»è¾‘
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            function updateThemeIcon() {
                const isDark = html.getAttribute('data-theme') === 'dark';
                themeToggle.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            }

            themeToggle.addEventListener('click', () => {
                const current = html.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon();
            });

            const savedTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon();

            // åŠ è½½æˆå‘˜åå•
            try {
                const response = await fetch(`https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/user.json?t=${Date.now()}`);
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½ user.json');
                const usernames = await response.json();

                if (!Array.isArray(usernames)) {
                    throw new Error('user.json æ ¼å¼é”™è¯¯ï¼šåº”ä¸ºå­—ç¬¦ä¸²æ•°ç»„');
                }

                const auth = getCookie('auth');
                const selfUsername = auth?.battletag || null;

                const grid = document.getElementById('membersGrid');
                if (!grid) return;
                grid.innerHTML = '';

                // å¹¶è¡Œè·å–æ‰€æœ‰ç”¨æˆ·èµ„æ–™
                const userPromises = usernames.map(username =>
                    fetch(`https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/${encodeURIComponent(username)}/${encodeURIComponent(username)}.json?t=${Date.now()}`)
                        .then(res => {
                            if (!res.ok) {
                                console.warn(`ç”¨æˆ·èµ„æ–™åŠ è½½å¤±è´¥: ${username}`, res.status);
                                return { username, hero: [], error: true };
                            }
                            return res.json().then(data => ({ username, ...data }));
                        })
                        .catch(err => {
                            console.error(`è¯·æ±‚ç”¨æˆ· ${username} å¤±è´¥:`, err);
                            return { username, hero: [], error: true };
                        })
                );

                const users = await Promise.all(userPromises);

                let selfUser = null;
                const otherUsers = [];

                users.forEach(user => {
                    if (user.username === selfUsername) {
                        selfUser = user;
                    } else {
                        otherUsers.push(user);
                    }
                });

                const allUsers = selfUser ? [selfUser, ...otherUsers] : otherUsers;

                // âœ… å…³é”®ï¼šå¹¶è¡Œé¢„åŠ è½½æ‰€æœ‰ç”¨æˆ·çš„ç‚¹èµæ•°æ®ï¼ˆç¡®ä¿ likeCache å¡«å……ï¼‰
                await Promise.all(allUsers.map(user => fetchLikes(user.username)));

                // âœ… ä¸å†é¢„åŠ è½½è¯„ä»·æ•°æ®ï¼Œä»…åœ¨ç‚¹å‡»æ—¶åŠ è½½
                // await Promise.all(allUsers.map(user => fetchEvaluations(user.username)));

                // âœ… å…³é”®ï¼šæ’åºï¼ˆæ­¤æ—¶ç¼“å­˜å·²å°±ç»ªï¼‰
                const sortedUsers = sortMembersBySelfLike(allUsers);

                // âœ… åªåœ¨æ­¤å¤„åˆ›å»ºå¹¶æ’å…¥å¡ç‰‡ï¼ˆé¿å…é‡å¤ï¼‰
                const greetings = [
                    'åˆ«æ¥æ— æ™~',
                    'å¥½ä¹…ä¸è§ï¼',
                    'æ¬¢è¿ä½ ï¼Œç‰¹å·¥',
                    'è¿‘æ¥å¯å¥½ï¼Ÿ',
                    'ä»Šå¤©å¤©æ°”ä¸é”™',
                    'é»‘çˆªéœ€è¦ä½ ',
                    'åˆè§é¢äº†ï¼'
                ];

                for (const user of sortedUsers) {
                    const card = document.createElement('div');
                    card.className = 'member-card';

                    const isSelf = (user.username === selfUsername);
                    if (isSelf) {
                        card.setAttribute('data-is-self', 'true');
                    }

                    const avatarPath = `./imge/${encodeURIComponent(user.username)}.jpg`;

                    let textContent = '';
                    if (isSelf) {
                        const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
                        textContent += `<div class="member-greeting">${randomGreeting}</div>`;
                    }
                    textContent += `<div class="member-id">${user.username}</div>`;

                    const header = document.createElement('div');
                    header.className = 'member-header';
                    header.innerHTML = `
                <img src="${avatarPath}" alt="${user.username}" class="member-avatar" onerror="this.style.opacity='0.4'; this.nextElementSibling.querySelector('.member-id').style.opacity='0.7'">
                <div class="member-text">${textContent}</div>
            `;

                    const heroesContainer = document.createElement('div');
                    heroesContainer.className = 'member-heroes';

                    if (user.hero && Array.isArray(user.hero)) {
                        user.hero.slice(0, 5).forEach(heroKey => {
                            const heroEl = document.createElement('div');
                            heroEl.className = 'member-hero-icon';
                            heroEl.innerHTML = `<img src="https://ow.mapleqaq.top/hero/${encodeURIComponent(heroKey)}.png" alt="${heroKey}" loading="lazy">`;
                            heroesContainer.appendChild(heroEl);
                        });
                    }

                    // æ®µä½æ˜¾ç¤º
                    let rankHTML = '';
                    if (user.Rank && user.Rank.rank && typeof user.Rank.level === 'number') {
                        const validRanks = ['silver', 'gold', 'diamond', 'master', 'grandmaster'];
                        if (validRanks.includes(user.Rank.rank) && user.Rank.level >= 1 && user.Rank.level <= 5) {
                            rankHTML = `
                        <div class="member-rank">
                            <img src="./imge/rank/${user.Rank.rank}.png" alt="${user.Rank.rank}" />
                            <span class="rank-level">${user.Rank.level}</span>
                        </div>
                    `;
                        }
                    }

                    card.appendChild(header);
                    card.appendChild(heroesContainer);

                    // ğŸ‘‡ å…ˆé™„åŠ æ®µä½+ç‚¹èµæŒ‰é’®å®¹å™¨ï¼ˆåŒ…å«å¿ƒå½¢ï¼‰
                    attachRankToLikeButton(card, rankHTML);

                    // ğŸ‘‡ æ·»åŠ ç©ºçš„ like-list å ä½ï¼ˆç”¨äºåç»­å±•å¼€ï¼‰
                    const likeListPlaceholder = document.createElement('div');
                    likeListPlaceholder.className = 'like-list';
                    likeListPlaceholder.style.display = 'none';
                    card.appendChild(likeListPlaceholder);

                    // ğŸ‘‡ æ·»åŠ è¯„ä»·æŒ‰é’®ï¼ˆå³ä¸‹è§’ï¼‰
                    const evaluationBtn = document.createElement('div');
                    evaluationBtn.className = 'evaluation-button';
                    evaluationBtn.innerHTML = 'ğŸ’¬';
                    evaluationBtn.style.position = 'absolute';
                    evaluationBtn.style.bottom = '8px';
                    evaluationBtn.style.right = '8px';
                    evaluationBtn.style.cursor = 'pointer';
                    evaluationBtn.style.fontSize = '18px';
                    evaluationBtn.style.zIndex = '10';
                    evaluationBtn.style.textShadow = '0 0 3px rgba(0,0,0,0.7)';

                    evaluationBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleEvaluationClick(card, user.username);
                    });

                    card.appendChild(evaluationBtn);

                    // ğŸ‘‡ æ·»åŠ ç©ºçš„ evaluation-list å ä½ï¼ˆç”¨äºåç»­å±•å¼€ï¼‰
                    const evaluationListPlaceholder = document.createElement('div');
                    evaluationListPlaceholder.className = 'evaluation-list';
                    evaluationListPlaceholder.style.display = 'none';
                    card.appendChild(evaluationListPlaceholder);

                    // ğŸ‘‡ æ’å…¥åˆ°ç½‘æ ¼
                    grid.appendChild(card);
                }

                if (sortedUsers.length === 0) {
                    grid.innerHTML = '<p style="text-align:center;color:var(--accent);">ostringstream</p>';
                }
            } catch (err) {
                console.error('åŠ è½½æˆå‘˜åå•å¤±è´¥:', err);
                const grid = document.getElementById('membersGrid');
                if (grid) {
                    grid.innerHTML = '<p style="text-align:center;color:var(--accent);">âš ï¸ æ— æ³•åŠ è½½æˆå‘˜åå•</p>';
                }
            }
        }
        /**
         * å°†æ®µä½å›¾æ ‡æ­£ç¡®è´´åˆåˆ°ç‚¹èµæŒ‰é’®å·¦ä¾§ï¼Œå¹¶ç¡®ä¿åˆå§‹ç‚¹èµæ•°æ­£ç¡®æ˜¾ç¤º
         * @param {HTMLElement} card - æˆå‘˜å¡ç‰‡ DOM å…ƒç´ 
         * @param {string} rankElementHTML - æ®µä½ HTML å­—ç¬¦ä¸²
         */
        function attachRankToLikeButton(card, rankElementHTML) {
            // è·å–æˆ–åˆ›å»ºå®¹å™¨
            let likeContainer = card.querySelector('.like-button-container');
            if (!likeContainer) {
                likeContainer = document.createElement('div');
                likeContainer.className = 'like-button-container';
                Object.assign(likeContainer.style, {
                    position: 'absolute',
                    top: '8px',
                    right: '8px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                    zIndex: '10',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    textShadow: '0 0 3px rgba(0,0,0,0.7)',
                    cursor: 'pointer'
                });
                card.style.position = 'relative';
                card.appendChild(likeContainer);
            }

            // æ¸…ç©ºå®¹å™¨
            likeContainer.innerHTML = '';

            // 1. æ·»åŠ æ®µä½å›¾æ ‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if (rankElementHTML) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = rankElementHTML.trim();
                const rankEl = tempDiv.firstElementChild;
                if (rankEl) {
                    rankEl.style.position = 'relative';
                    rankEl.style.width = '24px';
                    rankEl.style.height = '24px';

                    const levelSpan = rankEl.querySelector('.rank-level');
                    if (levelSpan) {
                        Object.assign(levelSpan.style, {
                            position: 'absolute',
                            bottom: '1px',
                            right: '1px',
                            fontSize: '9px',
                            fontWeight: 'bold',
                            color: '#fff',
                            backgroundColor: 'rgba(0,0,0,0.6)',
                            borderRadius: '2px',
                            padding: '0 1px',
                            lineHeight: '1',
                            zIndex: '2'
                        });
                    }
                    likeContainer.appendChild(rankEl);
                }
            }

            // 2. æ·»åŠ ç‚¹èµæ•°å­—ï¼ˆå…ˆè®¾ä¸º 0ï¼Œç¨åæ›´æ–°ï¼‰
            const countSpan = document.createElement('span');
            countSpan.className = 'like-count';
            countSpan.style.color = '#ffffff';
            countSpan.textContent = '0'; // åˆå§‹ä¸º 0ï¼Œä½†é©¬ä¸Šä¼šæ›´æ–°
            likeContainer.appendChild(countSpan);

            // 3. æ·»åŠ å¿ƒå½¢å›¾æ ‡
            const heartIcon = document.createElement('span');
            heartIcon.innerHTML = 'â¤ï¸';
            heartIcon.style.color = '#ff4d6d';
            likeContainer.appendChild(heartIcon);

            // 4. ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆé˜²é‡å¤ç»‘å®šï¼‰
            if (!likeContainer.hasClickHandler) {
                likeContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isSelf = card.hasAttribute('data-is-self');
                    const username = card.querySelector('.member-id')?.textContent;
                    if (username) {
                        handleLikeClick(card, username, isSelf);
                    }
                });
                likeContainer.hasClickHandler = true;
            }

            // âœ… å…³é”®ä¿®å¤ï¼šç«‹å³æ›´æ–°ç‚¹èµæ•°æ˜¾ç¤ºï¼ˆå¿…é¡»åœ¨ .like-count å­˜åœ¨åè°ƒç”¨ï¼‰
            const username = card.querySelector('.member-id')?.textContent;
            if (username) {
                updateLikeCountDisplay(card, username);
            }
        }


        function sortMembersBySelfLike(members) {
            const selfTag = getCookie('auth')?.battletag;
            if (!selfTag) return members; // æœªç™»å½•åˆ™ä¸æ’åº

            return [...members].sort((a, b) => {
                const isA = (a.username === selfTag);
                const isB = (b.username === selfTag);

                // æœ¬äººä¼˜å…ˆ
                if (isA && !isB) return -1; // a æ˜¯æœ¬äºº â†’ æ’å‰é¢
                if (!isA && isB) return 1;  // b æ˜¯æœ¬äºº â†’ b æ’å‰é¢

                // éƒ½ä¸æ˜¯æœ¬äººï¼šæŒ‰ self çš„ç‚¹èµæ•°é™åº
                const likesA = likeCache.get(a.username) || [];
                const likesB = likeCache.get(b.username) || [];

                const tempA = tempSelfLikeMap.get(a.username) || 0;
                const tempB = tempSelfLikeMap.get(b.username) || 0;

                const recordA = likesA.find(item => item.ID === selfTag)?.Like || 0;
                const recordB = likesB.find(item => item.ID === selfTag)?.Like || 0;

                const totalA = recordA + tempA;
                const totalB = recordB + tempB;

                return totalB - totalA; // é«˜èµåœ¨å‰
            });
        }
        // æ›´æ–°å¡ç‰‡ä¸Šæ˜¾ç¤ºçš„ç‚¹èµæ•°é‡
        function updateLikeCountDisplay(card, username) {
            const likeCountElement = card.querySelector('.like-count');
            if (!likeCountElement) return;

            // ä»ç¼“å­˜è·å–å·²æäº¤çš„ç‚¹èµæ•°æ®
            const likes = likeCache.get(username) || [];
            const selfTag = getCookie('auth')?.battletag;
            let total = getTotalLikes(username); // å·²æäº¤çš„æ€»æ•°

            // åŠ ä¸Šå½“å‰æœªæäº¤çš„ä¸´æ—¶å¢é‡ï¼ˆè‡ªå·±ç‚¹çš„ï¼‰
            const tempIncrement = tempSelfLikeMap.get(username) || 0;
            total += tempIncrement;

            // å¦‚æœæ˜¯è‡ªå·±çœ‹è‡ªå·±ï¼Œä¸”æœ‰ pending ç‚¹èµï¼Œä¹Ÿåº”æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
            // æ­¤å¤„å·²åŒ…å« tempSelfLikeMapï¼Œæ‰€ä»¥æ— éœ€é¢å¤–å¤„ç†

            likeCountElement.textContent = total;
        }

        // ========== è¯„ä»·ç›¸å…³é€»è¾‘ ==========

        // æ¸…ç†æ–‡æœ¬å‡½æ•°
        function cleanEvaluationText(text) {
            return (text || '')
                .replace(/[\r\n]+/g, ' ')  // æ¢è¡Œè½¬ç©ºæ ¼
                .replace(/\s+/g, ' ')       // å¤šä¸ªç©ºæ ¼è½¬ä¸€ä¸ª
                .trim();
        }

        // è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦ï¼ˆé˜² XSSï¼‰
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // å¤„ç†è¯„ä»·ç‚¹å‡»ï¼ˆæ˜¾ç¤ºè¯„ä»·åˆ—è¡¨å’Œè¾“å…¥æ¡†ï¼‰
        function handleEvaluationClick(card, targetUser) {
            // å¦‚æœå½“å‰ç‚¹å‡»çš„å¡ç‰‡å°±æ˜¯å·²æ‰“å¼€çš„è¯„ä»·åˆ—è¡¨ï¼Œåˆ™æ”¶èµ·
            const listContainer = card.querySelector('.evaluation-list');
            if (currentOpenEvaluationList && currentOpenEvaluationList === listContainer && currentOpenEvaluationList.style.display === 'block') {
                currentOpenEvaluationList.style.display = 'none';
                currentOpenEvaluationList = null;
                return;
            }

            // å…³é—­ä»»ä½•å·²æ‰“å¼€çš„ç‚¹èµåˆ—è¡¨
            if (currentOpenLikeList) {
                currentOpenLikeList.style.display = 'none';
                currentOpenLikeList = null;
            }

            // å…³é—­å…¶ä»–å·²æ‰“å¼€çš„è¯„ä»·åˆ—è¡¨
            if (currentOpenEvaluationList) {
                currentOpenEvaluationList.style.display = 'none';
            }

            renderEvaluationList(card, targetUser);
        }

        // æ¸²æŸ“æŸä¸ªç”¨æˆ·çš„è¯„ä»·åˆ—è¡¨ï¼ˆusername = è¢«è¯„ä»·è€…ï¼‰
        async function renderEvaluationList(card, username) {
            const selfTag = getCookie('auth')?.battletag;
            const evaluations = await fetchEvaluations(username);

            // è·å–æˆ–åˆ›å»º .evaluation-list å®¹å™¨
            let listContainer = card.querySelector('.evaluation-list');
            if (!listContainer) {
                listContainer = document.createElement('div');
                listContainer.className = 'evaluation-list';
                Object.assign(listContainer.style, {
                    position: 'absolute',
                    top: '100%',
                    left: '0',
                    right: '0',
                    backgroundColor: 'rgba(0,0,0,0.85)',
                    borderRadius: '0 0 8px 8px',
                    padding: '8px 0',
                    zIndex: '5',
                    display: 'none',
                    maxHeight: '300px',
                    overflowY: 'auto'
                });
                card.style.position = 'relative';
                card.appendChild(listContainer);
            }

            // æ¸…ç©ºå†…å®¹
            listContainer.innerHTML = '';

            // æ˜¾ç¤ºç°æœ‰è¯„ä»·
            if (evaluations.length === 0) {
                listContainer.innerHTML = '<div style="padding:6px;text-align:center;color:#aaa;">æš‚æ— è¯„ä»·</div>';
            } else {
                evaluations.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'evaluation-item';
                    Object.assign(itemEl.style, {
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '4px 12px',
                        borderBottom: '1px solid rgba(255,255,255,0.1)'
                    });

                    // âœ… ç”Ÿæˆå”¯ä¸€ IDï¼ševal-è¢«è¯„ä»·è€…-è¯„ä»·è€…
                    const uniqueId = `eval-${username}-${item.ID}`;

                    // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·è‡ªå·±çš„è¯„ä»·ï¼Œæ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                    if (selfTag && item.ID === selfTag) {
                        itemEl.innerHTML = `
          <div class="evaluation-item-content">
            <span class="evaluation-item-id">${item.ID}:</span>
            <span class="evaluation-item-evaluation" id="${uniqueId}">${escapeHtml(item.evaluation)}</span>
          </div>
          <div class="evaluation-actions">
            <button class="evaluation-edit-btn" data-id="${item.ID}" data-username="${username}">ä¿®æ”¹</button>
          </div>
        `;
                    } else {
                        // éå½“å‰ç”¨æˆ·è¯„ä»·ï¼Œä¸æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                        itemEl.innerHTML = `
          <div class="evaluation-item-content">
            <span class="evaluation-item-id">${item.ID}:</span>
            <span class="evaluation-item-evaluation">${escapeHtml(item.evaluation)}</span>
          </div>
          <div class="evaluation-actions">
            <span class="evaluation-read-only"></span>
          </div>
        `;
                    }
                    listContainer.appendChild(itemEl);
                });
            }

            // æ·»åŠ è¯„ä»·è¾“å…¥æ¡†ï¼ˆä»…å¯¹è‡ªå·±å¯è§ï¼Œä¸”å½“å‰ç”¨æˆ·æ²¡æœ‰è¯„ä»·æ—¶ï¼‰
            if (selfTag) {
                const existingEval = evaluations.find(item => item.ID === selfTag);
                if (!existingEval) {
                    const inputContainer = document.createElement('div');
                    inputContainer.className = 'evaluation-input-container';
                    inputContainer.style.padding = '8px';
                    inputContainer.style.borderTop = '1px solid rgba(255,255,255,0.1)';

                    inputContainer.innerHTML = `
        <textarea class="evaluation-input" placeholder="è¯·è¾“å…¥è¯„ä»·ï¼ˆæœ€å¤š32å­—ï¼‰" maxlength="32" rows="2"></textarea>
        <div class="evaluation-input-actions">
          <button class="evaluation-submit-btn" data-username="${username}">æäº¤</button>
        </div>
      `;

                    listContainer.appendChild(inputContainer);

                    const input = inputContainer.querySelector('.evaluation-input');
                    const submitBtn = inputContainer.querySelector('.evaluation-submit-btn');

                    submitBtn.addEventListener('click', () => {
                        const evalText = input.value.trim();
                        if (evalText === '') {
                            if (confirm('è¯„ä»·å†…å®¹ä¸ºç©ºï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ')) {
                                submitEvaluation(username, evalText);
                            }
                        } else if (evalText.length > 32) {
                            alert('è¯„ä»·ä¸èƒ½è¶…è¿‡32ä¸ªå­—ç¬¦ï¼');
                        } else {
                            submitEvaluation(username, evalText);
                        }
                    });
                }
            }

            // å…³é”®é€»è¾‘ï¼šå…ˆå…³é—­å½“å‰æ‰“å¼€çš„åˆ—è¡¨ï¼ˆå¦‚æœä¸æ˜¯åŒä¸€ä¸ªï¼‰
            if (currentOpenEvaluationList && currentOpenEvaluationList !== listContainer) {
                currentOpenEvaluationList.style.display = 'none';
            }

            // æ˜¾ç¤ºæ–°åˆ—è¡¨
            listContainer.style.display = 'block';
            currentOpenEvaluationList = listContainer; // æ›´æ–°å½“å‰æ‰“å¼€çš„å¼•ç”¨

            // âœ… ä¿®æ­£ï¼šä¸ºå½“å‰åˆ—è¡¨å•ç‹¬ç»‘å®šäº‹ä»¶ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
            // å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingListener = listContainer._evaluationListener;
            if (existingListener) {
                listContainer.removeEventListener('click', existingListener);
            }

            // åˆ›å»ºæ–°çš„äº‹ä»¶ç›‘å¬å™¨
            const newListener = function (event) {
                const editBtn = event.target.closest('.evaluation-edit-btn');
                if (editBtn) {
                    event.preventDefault();
                    event.stopPropagation();

                    const id = editBtn.getAttribute('data-id');
                    const username = editBtn.getAttribute('data-username');
                    // âœ… ä½¿ç”¨å”¯ä¸€ ID æŸ¥æ‰¾å…ƒç´ 
                    const evalTextElement = document.getElementById(`eval-${username}-${id}`);
                    if (!evalTextElement) {
                        console.error('æœªæ‰¾åˆ°è¯„ä»·å…ƒç´ :', `eval-${username}-${id}`);
                        return;
                    }

                    let originalText = evalTextElement.textContent || '';
                    originalText = cleanEvaluationText(originalText);

                    evalTextElement.innerHTML = `<textarea class="evaluation-edit-input" maxlength="32" rows="2">${escapeHtml(originalText)}</textarea>`;

                    const actionsContainer = editBtn.parentElement;
                    actionsContainer.innerHTML = `
        <button class="evaluation-update-btn" data-id="${id}" data-username="${username}">æäº¤</button>
        <button class="evaluation-cancel-btn" data-id="${id}" data-username="${username}">å–æ¶ˆ</button>
      `;
                }

                const updateBtn = event.target.closest('.evaluation-update-btn');
                if (updateBtn) {
                    event.preventDefault();
                    event.stopPropagation();

                    const id = updateBtn.getAttribute('data-id');
                    const username = updateBtn.getAttribute('data-username');
                    // âœ… ä½¿ç”¨å”¯ä¸€ ID æŸ¥æ‰¾å…ƒç´ 
                    const evalTextElement = document.getElementById(`eval-${username}-${id}`);
                    if (!evalTextElement) return;

                    const newEvalText = evalTextElement.querySelector('.evaluation-edit-input').value.trim();
                    if (newEvalText.length > 32) {
                        alert('è¯„ä»·ä¸èƒ½è¶…è¿‡32ä¸ªå­—ç¬¦ï¼');
                        return;
                    }
                    submitEvaluation(username, newEvalText);
                }

                const cancelBtn = event.target.closest('.evaluation-cancel-btn');
                if (cancelBtn) {
                    event.preventDefault();
                    event.stopPropagation();

                    const id = cancelBtn.getAttribute('data-id');
                    const username = cancelBtn.getAttribute('data-username');
                    // âœ… ä½¿ç”¨å”¯ä¸€ ID æŸ¥æ‰¾å…ƒç´ 
                    const evalTextElement = document.getElementById(`eval-${username}-${id}`);
                    if (!evalTextElement) return;

                    const evaluations = evaluationCache.get(username) || [];
                    const originalItem = evaluations.find(item => item.ID === id);
                    const originalText = originalItem?.evaluation || '';

                    evalTextElement.textContent = originalText;
                    const actionsContainer = cancelBtn.parentElement;
                    actionsContainer.innerHTML = `
        <button class="evaluation-edit-btn" data-id="${id}" data-username="${username}">ä¿®æ”¹</button>
      `;
                }
            };

            // ç»‘å®šæ–°ç›‘å¬å™¨å¹¶ä¿å­˜å¼•ç”¨
            listContainer.addEventListener('click', newListener);
            listContainer._evaluationListener = newListener;
        }





        // ========== å¯åŠ¨æµç¨‹ ==========
        document.addEventListener('DOMContentLoaded', async function () {
            const isValid = await verifyAuth();
            if (isValid) {
                initPage();
            }
        });



    </script>


    </div> <!-- è¿™æ˜¯ #joinPlayContainer çš„é—­åˆæ ‡ç­¾ -->

    <!-- âœ… å†æ”¾åº•éƒ¨å¯¼èˆªæ  -->
    <div class="fixed-bottom-nav">
        <a href="./news.html" class="nav-tab">
            <div>é»‘çˆªåŠ¨æ€</div>
        </a>
        <a href="./main.html" class="nav-tab active">
            <div>ä¸»é¡µ</div>
        </a>
        <a href="./profile.html" class="nav-tab">
            <div>æˆ‘çš„</div>
        </a>
    </div>

</body>

</html>
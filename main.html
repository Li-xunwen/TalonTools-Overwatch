<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ˆæœ›å…ˆé”‹é»‘çˆªä¼šè®®å®¤</title>
    <link rel="stylesheet" href="styles/main.css">
</head>

<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" id="themeToggle">ğŸŒ™</button>

    <div class="join-play" id="joinPlayContainer">
        <div class="floating-elements" id="floatingElements"></div>


        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <div class="top-tip-text">è¿™ä¸ªæœªæ¥å€¼å¾—ä¸ºä¹‹å¥‹æˆ˜</div>
            <!-- å¤´å›¾æµ·æŠ¥åŒºåŸŸ -->
            <div class="poster-wrapper">
                <div class="poster-container">
                    <!-- é¡µé¢æœ€é¡¶ç«¯æç¤º -->
                    <div class="play-hero hero1" id="hero1"></div>
                    <div class="play-hero hero2" id="hero2"></div>
                    <div class="play-hero hero3" id="hero3"></div>
                    <div class="play-hero hero4" id="hero4"></div>
                    <div class="play-hero hero5" id="hero5"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æˆå‘˜åå•</h2>
                <div class="members-grid" id="membersGrid">
                    <!-- æˆå‘˜åç‰‡ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æ´»åŠ¨äº®ç‚¹</h2>
                <div class="test-elements-grid">
                    <div class="test-element">ç‰¹è‰²ç©æ³•</div>
                    <div class="test-element">é™å®šçš®è‚¤</div>
                    <div class="test-element">ä¸“å±æˆå°±</div>
                    <div class="test-element">å›¢é˜Ÿç«æŠ€</div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æµ‹è¯•å†…å®¹åŒºåŸŸ</h2>
                <p class="section-content">
                    æ­¤åŒºåŸŸç”¨äºå±•ç¤ºæµ‹è¯•å…ƒç´ å’Œå ä½å†…å®¹ã€‚<br>
                    åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™é‡Œå°†åŒ…å«æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€æ’è¡Œæ¦œã€ç©å®¶ç»Ÿè®¡æ•°æ®ç­‰å†…å®¹ã€‚
                </p>
                <div class="test-elements-grid">
                    <div class="test-element">æ•°æ®ç»Ÿè®¡</div>
                    <div class="test-element">æ’è¡Œæ¦œ</div>
                    <div class="test-element">å¥–åŠ±é¢„è§ˆ</div>
                    <div class="test-element">ç©å®¶ç¤¾åŒº</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ========== èº«ä»½éªŒè¯å®ˆå« ==========
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                try {
                    return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
        }

        async function verifyAuth() {
            const auth = getCookie('auth');
            if (!auth || !auth.battletag || !auth.passwordHash) {
                deleteCookie('auth');
                window.location.href = './';
                return false;
            }

            const { battletag, passwordHash } = auth;
            const expectedPrefix = passwordHash.substring(0, 16).toUpperCase();
            const encodedTag = encodeURIComponent(battletag);
            const url = `https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTag}/${encodedTag}.json?t=${Date.now()}`;

            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error('User data not found');

                const userData = await res.json();
                const serverPwd16 = (userData.PWD16Byte || '').toUpperCase();

                if (expectedPrefix !== serverPwd16) {
                    throw new Error('Password mismatch');
                }

                // éªŒè¯é€šè¿‡ï¼Œç»§ç»­æ¸²æŸ“é¡µé¢
                return true;
            } catch (err) {
                console.warn('èº«ä»½éªŒè¯å¤±è´¥:', err);
                deleteCookie('auth');
                window.location.href = './';
                return false;
            }
        }

        // ========== åŸæœ‰é¡µé¢é€»è¾‘ï¼ˆå°è£…ä¸ºå‡½æ•°ï¼‰==========
        const heroesData = [
            { en: 'doomfist', zh: 'æœ«æ—¥é“æ‹³' },
            { en: 'cassidy', zh: 'å¡è¥¿è¿ª' },
            { en: 'genji', zh: 'æºæ°' },
            { en: 'pharah', zh: 'æ³•è€ä¹‹é¹°' },
            { en: 'reaper', zh: 'æ­»ç¥' },
            { en: 'soldier-76', zh: 'å£«å…µï¼š76' },
            { en: 'sombra', zh: 'é»‘å½±' },
            { en: 'tracer', zh: 'çŒç©º' },
            { en: 'bastion', zh: 'å ¡å’' },
            { en: 'hanzo', zh: 'åŠè—' },
            { en: 'junkrat', zh: 'ç‹‚é¼ ' },
            { en: 'mei', zh: 'ç¾' },
            { en: 'torbjorn', zh: 'æ‰˜æ¯”æ˜‚' },
            { en: 'widowmaker', zh: 'é»‘ç™¾åˆ' },
            { en: 'ashe', zh: 'è‰¾ä»€' },
            { en: 'echo', zh: 'å›å£°' },
            { en: 'sojourn', zh: 'ç´¢æ°æ©' },
            { en: 'ana', zh: 'å®‰å¨œ' },
            { en: 'baptiste', zh: 'å·´è’‚æ–¯ç‰¹' },
            { en: 'brigitte', zh: 'å¸ƒä¸½å‰å¡”' },
            { en: 'lucio', zh: 'å¢è¥¿å¥¥' },
            { en: 'mercy', zh: 'å¤©ä½¿' },
            { en: 'moira', zh: 'è«ä¼Šæ‹‰' },
            { en: 'zenyatta', zh: 'ç¦…é›…å¡”' },
            { en: 'kiriko', zh: 'é›¾å­' },
            { en: 'lifeweaver', zh: 'ç”Ÿå‘½ä¹‹æ¢­' },
            { en: 'sigma', zh: 'è¥¿æ ¼ç›' },
            { en: 'orisa', zh: 'å¥¥ä¸½è' },
            { en: 'ramattra', zh: 'æ‹‰ç›åˆ¹' },
            { en: 'reinhardt', zh: 'è±å› å“ˆç‰¹' },
            { en: 'roadhog', zh: 'è·¯éœ¸' },
            { en: 'winston', zh: 'æ¸©æ–¯é¡¿' },
            { en: 'wrecking-ball', zh: 'ç ´åçƒ' },
            { en: 'zarya', zh: 'æŸ¥è‰å¨…' },
            { en: 'dva', zh: 'D.Va' },
            { en: 'junker-queen', zh: 'æ¸£å®¢å¥³ç‹' },
            { en: 'mauga', zh: 'æ¯›åŠ ' },
            { en: 'hazard', zh: 'éª‡ç¾' },
            { en: 'freja', zh: 'å¼—è•¾é›…' },
            { en: 'juno', zh: 'æœ±è¯º' },
            { en: 'wuyang', zh: 'æ— æ¼¾' },
            { en: 'venture', zh: 'æ¢å¥‡' },
            { en: 'symmetra', zh: 'ç§©åºä¹‹å…‰' },
            { en: 'illari', zh: 'ä¼Šæ‹‰é”' }
        ];

        function initPage() {
            // åˆ›å»ºæµ®åŠ¨è£…é¥°å…ƒç´ 
            const floatingElements = document.getElementById('floatingElements');
            for (let i = 0; i < 20; i++) {
                const element = document.createElement('div');
                element.classList.add('floating-element');
                element.style.left = Math.random() * 100 + '%';
                element.style.top = Math.random() * 100 + '%';
                element.style.width = (Math.random() * 10 + 5) + 'px';
                element.style.height = element.style.width;
                element.style.animationDuration = (Math.random() * 10 + 10) + 's';
                element.style.animationDelay = Math.random() * 5 + 's';
                floatingElements.appendChild(element);
            }

            // è‹±é›„å‘¼å¸åŠ¨ç”»
            const heroes = document.querySelectorAll('.play-hero');
            heroes.forEach(hero => {
                resetHeroPosition(hero);
                setInterval(() => animateHeroBreathing(hero), 2000 + Math.random() * 3000);
            });

            function resetHeroPosition(hero) {
                hero.style.transition = 'transform 0s';
                hero.style.transform = 'translate(0, 0)';
                hero.offsetHeight;
                hero.style.transition = 'transform 3s ease-in-out';
            }

            function animateHeroBreathing(hero) {
                const tx = (Math.random() - 0.5) * 10;
                const ty = (Math.random() - 0.5) * 10;
                hero.style.transform = `translate(${tx}px, ${ty}px)`;
            }

            window.addEventListener('resize', () => {
                setTimeout(() => heroes.forEach(resetHeroPosition), 100);
            });

            // ä¸»é¢˜åˆ‡æ¢é€»è¾‘
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            function updateThemeIcon() {
                const isDark = html.getAttribute('data-theme') === 'dark';
                themeToggle.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            }

            themeToggle.addEventListener('click', () => {
                const current = html.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon();
            });

            const savedTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon();

            // åŠ è½½æˆå‘˜åå•
            fetch(`https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/user.json?t=${Date.now()}`)
                .then(response => {
                    if (!response.ok) throw new Error('æ— æ³•åŠ è½½ user.json');
                    return response.json();
                })
                .then(usernames => {
                    if (!Array.isArray(usernames)) {
                        throw new Error('user.json æ ¼å¼é”™è¯¯ï¼šåº”ä¸ºå­—ç¬¦ä¸²æ•°ç»„');
                    }

                    const auth = getCookie('auth');
                    const selfUsername = auth?.battletag || null;

                    const grid = document.getElementById('membersGrid');
                    if (!grid) return;
                    grid.innerHTML = '';

                    const userPromises = usernames.map(username =>
                        fetch(`https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/${encodeURIComponent(username)}/${encodeURIComponent(username)}.json?t=${Date.now()}`)
                            .then(res => {
                                if (!res.ok) {
                                    console.warn(`ç”¨æˆ·èµ„æ–™åŠ è½½å¤±è´¥: ${username}`, res.status);
                                    return { username, hero: [], error: true };
                                }
                                return res.json().then(data => ({ username, ...data }));
                            })
                            .catch(err => {
                                console.error(`è¯·æ±‚ç”¨æˆ· ${username} å¤±è´¥:`, err);
                                return { username, hero: [], error: true };
                            })
                    );

                    Promise.all(userPromises).then(users => {
                        // åˆ†ç¦»æœ¬äººå’Œä»–äºº
                        let selfUser = null;
                        const otherUsers = [];

                        users.forEach(user => {
                            if (user.username === selfUsername) {
                                selfUser = user;
                            } else {
                                otherUsers.push(user);
                            }
                        });

                        // å¦‚æœæœ¬äººå­˜åœ¨ï¼Œæ”¾åœ¨æœ€å‰é¢
                        const finalUsers = selfUser ? [selfUser, ...otherUsers] : otherUsers;

                        // éšæœºé—®å€™è¯­åº“ï¼ˆ3~8å­—ï¼‰
                        const greetings = [
                            'åˆ«æ¥æ— æ™~',
                            'å¥½ä¹…ä¸è§ï¼',
                            'æ¬¢è¿ä½ ï¼Œç‰¹å·¥',
                            'è¿‘æ¥å¯å¥½ï¼Ÿ',
                            'ä»Šå¤©å¤©æ°”ä¸é”™',
                            'é»‘çˆªéœ€è¦ä½ ',
                            'åˆè§é¢äº†ï¼'

                        ];

                        finalUsers.forEach(user => {
                            const card = document.createElement('div');
                            card.className = 'member-card';

                            const isSelf = (user.username === selfUsername);
                            if (isSelf) {
                                card.setAttribute('data-is-self', 'true'); // æ ‡è®°æœ¬äººï¼Œä¾¿äºåç»­å¼€å‘
                            }

                            const avatarPath = `./imge/${encodeURIComponent(user.username)}.jpg`;

                            // æ„å»ºæ–‡å­—åŒºåŸŸå†…å®¹
                            let textContent = '';
                            if (isSelf) {
                                const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
                                textContent += `<div class="member-greeting">${randomGreeting}</div>`;
                            }
                            textContent += `<div class="member-id">${user.username}</div>`;

                            const header = document.createElement('div');
                            header.className = 'member-header';
                            header.innerHTML = `
                    <img src="${avatarPath}" alt="${user.username}" class="member-avatar" onerror="this.style.opacity='0.4'; this.nextElementSibling.querySelector('.member-id').style.opacity='0.7'">
                    <div class="member-text">${textContent}</div>
                `;

                            const heroesContainer = document.createElement('div');
                            heroesContainer.className = 'member-heroes';

                            if (user.hero && Array.isArray(user.hero)) {
                                user.hero.slice(0, 5).forEach(heroKey => {
                                    const heroEl = document.createElement('div');
                                    heroEl.className = 'member-hero-icon';
                                    heroEl.innerHTML = `<img src="https://ow.mapleqaq.top/hero/${encodeURIComponent(heroKey)}.png" alt="${heroKey}" loading="lazy">`;
                                    heroesContainer.appendChild(heroEl);
                                });
                            }

                            card.appendChild(header);
                            card.appendChild(heroesContainer);
                            grid.appendChild(card);
                        });

                        if (finalUsers.length === 0) {
                            grid.innerHTML = '<p style="text-align:center;color:var(--accent);">ğŸ“­ æš‚æ— æˆå‘˜</p>';
                        }
                    });
                })
                .catch(err => {
                    console.error('åŠ è½½æˆå‘˜åå•å¤±è´¥:', err);
                    const grid = document.getElementById('membersGrid');
                    if (grid) {
                        grid.innerHTML = '<p style="text-align:center;color:var(--accent);">âš ï¸ æ— æ³•åŠ è½½æˆå‘˜åå•</p>';
                    }
                });
        }

        // ========== å¯åŠ¨æµç¨‹ ==========
        document.addEventListener('DOMContentLoaded', async function () {
            const isValid = await verifyAuth();
            if (isValid) {
                initPage(); // åªæœ‰éªŒè¯é€šè¿‡æ‰åˆå§‹åŒ–é¡µé¢
            }
        });
    </script>


    </div> <!-- è¿™æ˜¯ #joinPlayContainer çš„é—­åˆæ ‡ç­¾ -->

    <!-- âœ… å†æ”¾åº•éƒ¨å¯¼èˆªæ  -->
    <div class="fixed-bottom-nav">
        <a href="/news.html" class="nav-tab">
            <div>é»‘çˆªåŠ¨æ€</div>
        </a>
        <a href="./main.html" class="nav-tab active">
            <div>ä¸»é¡µ</div>
        </a>
        <a href="./profile.html" class="nav-tab">
            <div>æˆ‘çš„</div>
        </a>
    </div>

</body>

</html>
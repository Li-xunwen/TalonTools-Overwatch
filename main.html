<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ˆæœ›å…ˆé”‹é»‘çˆªä¼šè®®å®¤</title>
    <link rel="stylesheet" href="styles/main.css">
</head>

<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" id="themeToggle">ğŸŒ™</button>

    <div class="join-play" id="joinPlayContainer">
        <div class="floating-elements" id="floatingElements"></div>


        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <div class="top-tip-text">è¿™ä¸ªæœªæ¥å€¼å¾—ä¸ºä¹‹å¥‹æˆ˜</div>
            <!-- å¤´å›¾æµ·æŠ¥åŒºåŸŸ -->
            <div class="poster-wrapper">
                <div class="poster-container">
                    <!-- é¡µé¢æœ€é¡¶ç«¯æç¤º -->
                    <div class="play-hero hero1" id="hero1"></div>
                    <div class="play-hero hero2" id="hero2"></div>
                    <div class="play-hero hero3" id="hero3"></div>
                    <div class="play-hero hero4" id="hero4"></div>
                    <div class="play-hero hero5" id="hero5"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æˆå‘˜åå•</h2>
                <div class="members-grid" id="membersGrid">
                    <!-- æˆå‘˜åç‰‡ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æ´»åŠ¨äº®ç‚¹</h2>
                <div class="test-elements-grid">
                    <div class="test-element">ç‰¹è‰²ç©æ³•</div>
                    <div class="test-element">é™å®šçš®è‚¤</div>
                    <div class="test-element">ä¸“å±æˆå°±</div>
                    <div class="test-element">å›¢é˜Ÿç«æŠ€</div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">æµ‹è¯•å†…å®¹åŒºåŸŸ</h2>
                <p class="section-content">
                    æ­¤åŒºåŸŸç”¨äºå±•ç¤ºæµ‹è¯•å…ƒç´ å’Œå ä½å†…å®¹ã€‚<br>
                    åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™é‡Œå°†åŒ…å«æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€æ’è¡Œæ¦œã€ç©å®¶ç»Ÿè®¡æ•°æ®ç­‰å†…å®¹ã€‚
                </p>
                <div class="test-elements-grid">
                    <div class="test-element">æ•°æ®ç»Ÿè®¡</div>
                    <div class="test-element">æ’è¡Œæ¦œ</div>
                    <div class="test-element">å¥–åŠ±é¢„è§ˆ</div>
                    <div class="test-element">ç©å®¶ç¤¾åŒº</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ========== èº«ä»½éªŒè¯å®ˆå« ==========
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                try {
                    return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
        }

        async function verifyAuth() {
            const auth = getCookie('auth');
            if (!auth || !auth.battletag || !auth.passwordHash) {
                deleteCookie('auth');
                window.location.href = './';
                return false;
            }

            const { battletag, passwordHash } = auth;
            const expectedPrefix = passwordHash.substring(0, 16).toUpperCase();
            const encodedTag = encodeURIComponent(battletag);
            const url = `https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTag}/${encodedTag}.json?t=${Date.now()}`;

            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error('User data not found');

                const userData = await res.json();
                const serverPwd16 = (userData.PWD16Byte || '').toUpperCase();

                if (expectedPrefix !== serverPwd16) {
                    throw new Error('Password mismatch');
                }

                return true;
            } catch (err) {
                console.warn('èº«ä»½éªŒè¯å¤±è´¥:', err);
                deleteCookie('auth');
                window.location.href = './';
                return false;
            }
        }

        // ========== ç‚¹èµç›¸å…³é€»è¾‘ ==========
        const likeCache = new Map(); // ç¼“å­˜æ¯ä¸ªç”¨æˆ·çš„ç‚¹èµæ•°æ® { username => likeArray }
        const pendingLikes = new Map(); // è®°å½•å¾…æäº¤çš„ç‚¹èµå¢é‡ { targetUser => count }
        const likeTimeouts = new Map(); // ç”¨äºå»¶è¿Ÿæäº¤

        // è·å–æŸç”¨æˆ·çš„ç‚¹èµæ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
        async function fetchLikes(username) {
            if (likeCache.has(username)) {
                return likeCache.get(username);
            }

            const encoded = encodeURIComponent(username);
            const url = `https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/like/${encoded}.json?t=${Date.now()}`;

            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) {
                    if (res.status === 404) {
                        likeCache.set(username, []);
                        return [];
                    }
                    throw new Error('Network error');
                }
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error('Invalid format');
                likeCache.set(username, data);
                return data;
            } catch (err) {
                console.warn(`Failed to load likes for ${username}:`, err);
                likeCache.set(username, []);
                return [];
            }
        }

        // è®¡ç®—æ€»èµæ•°ï¼ˆä»ç¼“å­˜å–ï¼‰
        function getTotalLikes(username) {
            const likes = likeCache.get(username) || [];
            return likes.reduce((sum, item) => sum + (item.Like || 0), 0);
        }

        // æ›´æ–°å¡ç‰‡ä¸Šçš„æ€»èµæ•°æ˜¾ç¤ºï¼ˆæ”¯æŒä¸´æ—¶å¢é‡ï¼‰
        const tempLikeIncrements = new Map(); // username => increment (æœªæäº¤ä½†å·²æ˜¾ç¤º)


        // æäº¤ç‚¹èµå˜æ›´
        async function submitLikes(targetUser) {
            const selfTag = getCookie('auth')?.battletag;
            if (!selfTag) return;

            const encodedSelf = encodeURIComponent(selfTag);
            const encodedTarget = encodeURIComponent(targetUser);
            const url = `https://talon-public-1258609989.cos.ap-chongqing.myqcloud.com/like/${encodedTarget}.json`;

            let currentLikes = await fetchLikes(targetUser);
            currentLikes = [...currentLikes]; // clone

            const existing = currentLikes.find(item => item.ID === selfTag);
            const addCount = pendingLikes.get(targetUser) || 0;

            if (addCount <= 0) return;

            if (existing) {
                existing.Like += addCount;
            } else {
                currentLikes.push({ ID: selfTag, Like: addCount });
            }

            // æ’åºï¼ˆé«˜åˆ°ä½ï¼‰
            currentLikes.sort((a, b) => b.Like - a.Like);

            try {
                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentLikes)
                });

                if (!putRes.ok) throw new Error('PUT failed');

                // æ›´æ–°ç¼“å­˜
                likeCache.set(targetUser, currentLikes);
                pendingLikes.delete(targetUser);
                console.log(`âœ… æˆåŠŸæäº¤ ${addCount} ä¸ªèµç»™ ${targetUser}`);

                // æäº¤æˆåŠŸååˆ·æ–°å¯¹åº”å¡ç‰‡çš„ç‚¹èµæ•°
                const grid = document.getElementById('membersGrid');
                if (grid) {
                    const cards = grid.querySelectorAll('.member-card');
                    for (const card of cards) {
                        const idEl = card.querySelector('.member-id');
                        if (idEl && idEl.textContent === targetUser) {
                            updateLikeCountDisplay(card, targetUser);
                            break;
                        }
                    }
                }
            } catch (err) {
                console.error(`âŒ æäº¤ç‚¹èµå¤±è´¥ (${targetUser}):`, err);
                alert('ç‚¹èµæäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        const tempSelfLikeMap = new Map(); // username => temporary like count (for self)
        // è§¦å‘ç‚¹èµï¼ˆUI + è®¡æ•°ï¼‰
        function handleLikeClick(card, targetUser, isSelf) {
            const selfTag = getCookie('auth')?.battletag;
            if (!selfTag) return;

            if (isSelf) {
                renderLikeList(card, targetUser); // è‡ªå·±ä¹Ÿå…è®¸çœ‹åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
                return;
            }

            // å¢åŠ å¾…æäº¤è®¡æ•°
            const currentPending = pendingLikes.get(targetUser) || 0;
            pendingLikes.set(targetUser, currentPending + 1);

            // è®°å½•è‡ªå·±çš„ä¸´æ—¶ç‚¹èµæ•°ï¼ˆç”¨äº UI åˆ—è¡¨ï¼‰
            const currentTempSelf = tempSelfLikeMap.get(targetUser) || 0;
            tempSelfLikeMap.set(targetUser, currentTempSelf + 1);

            // ç«‹å³æ›´æ–°æ€»èµæ•°æ˜¾ç¤º
            updateLikeCountDisplay(card, targetUser);

            // è®¾ç½®è‡ªåŠ¨æäº¤ï¼ˆé˜²æŠ–ï¼‰
            clearTimeout(likeTimeouts.get(targetUser));
            likeTimeouts.set(targetUser, setTimeout(() => submitLikes(targetUser), 1200));

            // ğŸ‘‡ å…³é”®ä¿®å¤ï¼šç‚¹å‡»åå§‹ç»ˆå±•å¼€åˆ—è¡¨ï¼ˆä¸ toggleï¼‰
            renderLikeList(card, targetUser);
        }


        // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ‰“å¼€çš„ like-list å®¹å™¨
        let currentOpenLikeList = null;

        async function renderLikeList(card, username) {
            const selfTag = getCookie('auth')?.battletag;
            const likes = await fetchLikes(username);
            let displayLikes = [...likes];

            // åˆå¹¶ä¸´æ—¶ç‚¹èµï¼ˆåŒ…æ‹¬åˆšç‚¹çš„ï¼‰
            if (selfTag) {
                const tempSelfLike = tempSelfLikeMap.get(username) || 0;
                if (tempSelfLike > 0) {
                    const existingIndex = displayLikes.findIndex(item => item.ID === selfTag);
                    if (existingIndex >= 0) {
                        displayLikes[existingIndex] = {
                            ...displayLikes[existingIndex],
                            Like: (displayLikes[existingIndex].Like || 0) + tempSelfLike
                        };
                    } else {
                        displayLikes.push({ ID: selfTag, Like: tempSelfLike });
                    }
                }
            }

            // æ’åº
            displayLikes.sort((a, b) => (b.Like || 0) - (a.Like || 0));

            // è·å–æˆ–åˆ›å»º .like-list å®¹å™¨
            let listContainer = card.querySelector('.like-list');
            if (!listContainer) {
                listContainer = document.createElement('div');
                listContainer.className = 'like-list';
                Object.assign(listContainer.style, {
                    position: 'absolute',
                    top: '100%',
                    left: '0',
                    right: '0',
                    backgroundColor: 'rgba(0,0,0,0.85)',
                    borderRadius: '0 0 8px 8px',
                    padding: '8px 0',
                    zIndex: '5',
                    display: 'none',
                    maxHeight: '200px',
                    overflowY: 'auto'
                });
                card.style.position = 'relative';
                card.appendChild(listContainer);
            }

            // æ¸…ç©ºå†…å®¹
            listContainer.innerHTML = '';
            if (displayLikes.length === 0) {
                listContainer.innerHTML = '<div style="padding:6px;text-align:center;color:#aaa;">æš‚æ— ç‚¹èµ</div>';
            } else {
                displayLikes.slice(0, 10).forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'like-item';
                    Object.assign(itemEl.style, {
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '4px 12px',
                        borderBottom: '1px solid rgba(255,255,255,0.1)'
                    });
                    itemEl.innerHTML = `
                <span class="like-item-id">${item.ID}</span>
                <span class="like-item-like">â¤ï¸${item.Like}</span>
            `;
                    listContainer.appendChild(itemEl);
                });
            }

            // ğŸ‘‡ å…³é”®é€»è¾‘ï¼šå…ˆå…³é—­å½“å‰æ‰“å¼€çš„åˆ—è¡¨ï¼ˆå¦‚æœä¸æ˜¯åŒä¸€ä¸ªï¼‰
            if (currentOpenLikeList && currentOpenLikeList !== listContainer) {
                currentOpenLikeList.style.display = 'none';
            }

            // æ˜¾ç¤ºæ–°åˆ—è¡¨
            listContainer.style.display = 'block';
            currentOpenLikeList = listContainer; // æ›´æ–°å½“å‰æ‰“å¼€çš„å¼•ç”¨
        }

        // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ‰“å¼€çš„ like-list åŠå…¶å…³é—­å‡½æ•°
        let currentLikeList = null;
        let currentCloseHandler = null;

        async function toggleLikeList(card, username) {
            const selfTag = getCookie('auth')?.battletag;
            const likes = await fetchLikes(username);
            let displayLikes = [...likes];

            // åˆå¹¶ä¸´æ—¶ç‚¹èµ
            if (selfTag) {
                const tempSelfLike = tempSelfLikeMap.get(username) || 0;
                if (tempSelfLike > 0) {
                    const existingIndex = displayLikes.findIndex(item => item.ID === selfTag);
                    if (existingIndex >= 0) {
                        displayLikes[existingIndex] = {
                            ...displayLikes[existingIndex],
                            Like: (displayLikes[existingIndex].Like || 0) + tempSelfLike
                        };
                    } else {
                        displayLikes.push({ ID: selfTag, Like: tempSelfLike });
                    }
                }
            }

            displayLikes.sort((a, b) => (b.Like || 0) - (a.Like || 0));
            const total = displayLikes.reduce((sum, item) => sum + (item.Like || 0), 0);

            // è·å–å·²å­˜åœ¨çš„ .like-list å®¹å™¨
            const listContainer = card.querySelector('.like-list');
            if (!listContainer) return;

            // æ¸…ç©ºå†…å®¹
            listContainer.innerHTML = '';

            // æ¸²æŸ“å‰10å
            displayLikes.slice(0, 10).forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'like-item';
                itemEl.style.display = 'flex';
                itemEl.style.justifyContent = 'space-between';
                itemEl.style.alignItems = 'center';
                itemEl.style.padding = '4px 8px';
                itemEl.style.borderBottom = '1px solid rgba(255,255,255,0.1)';

                itemEl.innerHTML = `
            <span class="like-item-id">${item.ID}</span>
            <span class="like-item-like">â¤ï¸${item.Like}</span>
        `;
                listContainer.appendChild(itemEl);
            });

            // åˆ‡æ¢æ˜¾ç¤º/éšè—
            if (listContainer.style.display === 'block') {
                listContainer.style.display = 'none';
            } else {
                listContainer.style.display = 'block';
            }
        }

        // æ¸²æŸ“å¸¦æ•°å­—çš„ç‚¹èµæŒ‰é’®ï¼š[æ•°å­—] â¤ï¸
        function renderLikeButton(card, username) {
            let container = card.querySelector('.like-button-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'like-button-container';
                container.style.position = 'absolute';
                container.style.top = '8px';
                container.style.right = '8px';
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.gap = '4px';
                container.style.zIndex = '10';
                container.style.cursor = 'pointer';
                container.style.fontSize = '14px';
                container.style.fontWeight = 'bold';
                container.style.textShadow = '0 0 3px rgba(0,0,0,0.7)';
                card.style.position = 'relative';
                card.appendChild(container);

                const countSpan = document.createElement('span');
                countSpan.className = 'like-count';
                countSpan.style.color = '#ffffff'; // ç™½è‰²æ•°å­—
                countSpan.textContent = '0';

                const heartIcon = document.createElement('span');
                heartIcon.innerHTML = 'â¤ï¸';
                heartIcon.style.color = '#ff4d6d';

                container.appendChild(countSpan);
                container.appendChild(heartIcon);

                container.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isSelf = card.hasAttribute('data-is-self');
                    handleLikeClick(card, username, isSelf);
                });
            }

            // åˆå§‹åŒ–æ˜¾ç¤ºçœŸå®æ€»èµæ•°
            updateLikeCountDisplay(card, username);
        }

        // æ›´æ–°æŒ‰é’®æ—çš„æ•°å­—ï¼ˆå«ä¸´æ—¶å¢é‡ï¼‰
        function updateLikeCountDisplay(card, username) {
            const countSpan = card.querySelector('.like-count');
            if (!countSpan) return;

            const baseTotal = getTotalLikes(username);
            const pending = pendingLikes.get(username) || 0;
            countSpan.textContent = baseTotal + pending;
        }

        // æ›´æ–°æŒ‰é’®ä¸Šçš„æ€»èµæ•°ï¼ˆæ”¯æŒä¸´æ—¶å¢é‡ï¼‰
        function updateLikeButtonDisplay(card, username) {
            const likeBtn = card.querySelector('.like-button');
            if (!likeBtn) return;

            const countSpan = likeBtn.querySelector('.like-count');
            if (!countSpan) return;

            const baseTotal = getTotalLikes(username);
            const tempInc = pendingLikes.get(username) || 0; // æ³¨æ„ï¼špending æ˜¯å·²ç‚¹ä½†æœªæäº¤çš„ï¼Œåº”è®¡å…¥æ˜¾ç¤º
            countSpan.textContent = baseTotal + tempInc;
        }

        // ========== åŸæœ‰é¡µé¢é€»è¾‘ï¼ˆå°è£…ä¸ºå‡½æ•°ï¼‰==========
        const heroesData = [
            { en: 'doomfist', zh: 'æœ«æ—¥é“æ‹³' },
            { en: 'cassidy', zh: 'å¡è¥¿è¿ª' },
            { en: 'genji', zh: 'æºæ°' },
            { en: 'pharah', zh: 'æ³•è€ä¹‹é¹°' },
            { en: 'reaper', zh: 'æ­»ç¥' },
            { en: 'soldier-76', zh: 'å£«å…µï¼š76' },
            { en: 'sombra', zh: 'é»‘å½±' },
            { en: 'tracer', zh: 'çŒç©º' },
            { en: 'bastion', zh: 'å ¡å’' },
            { en: 'hanzo', zh: 'åŠè—' },
            { en: 'junkrat', zh: 'ç‹‚é¼ ' },
            { en: 'mei', zh: 'ç¾' },
            { en: 'torbjorn', zh: 'æ‰˜æ¯”æ˜‚' },
            { en: 'widowmaker', zh: 'é»‘ç™¾åˆ' },
            { en: 'ashe', zh: 'è‰¾ä»€' },
            { en: 'echo', zh: 'å›å£°' },
            { en: 'sojourn', zh: 'ç´¢æ°æ©' },
            { en: 'ana', zh: 'å®‰å¨œ' },
            { en: 'baptiste', zh: 'å·´è’‚æ–¯ç‰¹' },
            { en: 'brigitte', zh: 'å¸ƒä¸½å‰å¡”' },
            { en: 'lucio', zh: 'å¢è¥¿å¥¥' },
            { en: 'mercy', zh: 'å¤©ä½¿' },
            { en: 'moira', zh: 'è«ä¼Šæ‹‰' },
            { en: 'zenyatta', zh: 'ç¦…é›…å¡”' },
            { en: 'kiriko', zh: 'é›¾å­' },
            { en: 'lifeweaver', zh: 'ç”Ÿå‘½ä¹‹æ¢­' },
            { en: 'sigma', zh: 'è¥¿æ ¼ç›' },
            { en: 'orisa', zh: 'å¥¥ä¸½è' },
            { en: 'ramattra', zh: 'æ‹‰ç›åˆ¹' },
            { en: 'reinhardt', zh: 'è±å› å“ˆç‰¹' },
            { en: 'roadhog', zh: 'è·¯éœ¸' },
            { en: 'winston', zh: 'æ¸©æ–¯é¡¿' },
            { en: 'wrecking-ball', zh: 'ç ´åçƒ' },
            { en: 'zarya', zh: 'æŸ¥è‰å¨…' },
            { en: 'dva', zh: 'D.Va' },
            { en: 'junker-queen', zh: 'æ¸£å®¢å¥³ç‹' },
            { en: 'mauga', zh: 'æ¯›åŠ ' },
            { en: 'hazard', zh: 'éª‡ç¾' },
            { en: 'freja', zh: 'å¼—è•¾é›…' },
            { en: 'juno', zh: 'æœ±è¯º' },
            { en: 'wuyang', zh: 'æ— æ¼¾' },
            { en: 'venture', zh: 'æ¢å¥‡' },
            { en: 'symmetra', zh: 'ç§©åºä¹‹å…‰' },
            { en: 'illari', zh: 'ä¼Šæ‹‰é”' }
        ];

        async function initPage() {
            // åˆ›å»ºæµ®åŠ¨è£…é¥°å…ƒç´ 
            const floatingElements = document.getElementById('floatingElements');
            for (let i = 0; i < 20; i++) {
                const element = document.createElement('div');
                element.classList.add('floating-element');
                element.style.left = Math.random() * 100 + '%';
                element.style.top = Math.random() * 100 + '%';
                element.style.width = (Math.random() * 10 + 5) + 'px';
                element.style.height = element.style.width;
                element.style.animationDuration = (Math.random() * 10 + 10) + 's';
                element.style.animationDelay = Math.random() * 5 + 's';
                floatingElements.appendChild(element);
            }

            // è‹±é›„å‘¼å¸åŠ¨ç”»
            const heroes = document.querySelectorAll('.play-hero');
            heroes.forEach(hero => {
                resetHeroPosition(hero);
                setInterval(() => animateHeroBreathing(hero), 2000 + Math.random() * 3000);
            });

            function resetHeroPosition(hero) {
                hero.style.transition = 'transform 0s';
                hero.style.transform = 'translate(0, 0)';
                hero.offsetHeight;
                hero.style.transition = 'transform 3s ease-in-out';
            }

            function animateHeroBreathing(hero) {
                const tx = (Math.random() - 0.5) * 10;
                const ty = (Math.random() - 0.5) * 10;
                hero.style.transform = `translate(${tx}px, ${ty}px)`;
            }

            window.addEventListener('resize', () => {
                setTimeout(() => heroes.forEach(resetHeroPosition), 100);
            });

            // ä¸»é¢˜åˆ‡æ¢é€»è¾‘
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            function updateThemeIcon() {
                const isDark = html.getAttribute('data-theme') === 'dark';
                themeToggle.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            }

            themeToggle.addEventListener('click', () => {
                const current = html.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon();
            });

            const savedTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon();

            // åŠ è½½æˆå‘˜åå•ï¼ˆä½¿ç”¨ async/awaitï¼‰
            try {
                const response = await fetch(`https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/user.json?t=${Date.now()}`);
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½ user.json');
                const usernames = await response.json();

                if (!Array.isArray(usernames)) {
                    throw new Error('user.json æ ¼å¼é”™è¯¯ï¼šåº”ä¸ºå­—ç¬¦ä¸²æ•°ç»„');
                }

                const auth = getCookie('auth');
                const selfUsername = auth?.battletag || null;

                const grid = document.getElementById('membersGrid');
                if (!grid) return;
                grid.innerHTML = '';

                // å¹¶è¡Œè·å–æ‰€æœ‰ç”¨æˆ·èµ„æ–™
                const userPromises = usernames.map(username =>
                    fetch(`https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/${encodeURIComponent(username)}/${encodeURIComponent(username)}.json?t=${Date.now()}`)
                        .then(res => {
                            if (!res.ok) {
                                console.warn(`ç”¨æˆ·èµ„æ–™åŠ è½½å¤±è´¥: ${username}`, res.status);
                                return { username, hero: [], error: true };
                            }
                            return res.json().then(data => ({ username, ...data }));
                        })
                        .catch(err => {
                            console.error(`è¯·æ±‚ç”¨æˆ· ${username} å¤±è´¥:`, err);
                            return { username, hero: [], error: true };
                        })
                );

                const users = await Promise.all(userPromises);

                let selfUser = null;
                const otherUsers = [];

                users.forEach(user => {
                    if (user.username === selfUsername) {
                        selfUser = user;
                    } else {
                        otherUsers.push(user);
                    }
                });

                const finalUsers = selfUser ? [selfUser, ...otherUsers] : otherUsers;

                const greetings = [
                    'åˆ«æ¥æ— æ™~',
                    'å¥½ä¹…ä¸è§ï¼',
                    'æ¬¢è¿ä½ ï¼Œç‰¹å·¥',
                    'è¿‘æ¥å¯å¥½ï¼Ÿ',
                    'ä»Šå¤©å¤©æ°”ä¸é”™',
                    'é»‘çˆªéœ€è¦ä½ ',
                    'åˆè§é¢äº†ï¼'
                ];

                // âœ… å…³é”®ï¼šä½¿ç”¨ for...of + await ç¡®ä¿ç‚¹èµæ•°æ®å·²åŠ è½½
                for (const user of finalUsers) {
                    // é¢„åŠ è½½ç‚¹èµæ•°æ®ï¼ˆç¡®ä¿ç¼“å­˜æœ‰å€¼ï¼‰
                    await fetchLikes(user.username);

                    const card = document.createElement('div');
                    card.className = 'member-card';

                    const isSelf = (user.username === selfUsername);
                    if (isSelf) {
                        card.setAttribute('data-is-self', 'true');
                    }

                    const avatarPath = `./imge/${encodeURIComponent(user.username)}.jpg`;

                    let textContent = '';
                    if (isSelf) {
                        const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
                        textContent += `<div class="member-greeting">${randomGreeting}</div>`;
                    }
                    textContent += `<div class="member-id">${user.username}</div>`;

                    const header = document.createElement('div');
                    header.className = 'member-header';
                    header.innerHTML = `
            <img src="${avatarPath}" alt="${user.username}" class="member-avatar" onerror="this.style.opacity='0.4'; this.nextElementSibling.querySelector('.member-id').style.opacity='0.7'">
            <div class="member-text">${textContent}</div>
        `;

                    const heroesContainer = document.createElement('div');
                    heroesContainer.className = 'member-heroes';

                    if (user.hero && Array.isArray(user.hero)) {
                        user.hero.slice(0, 5).forEach(heroKey => {
                            const heroEl = document.createElement('div');
                            heroEl.className = 'member-hero-icon';
                            heroEl.innerHTML = `<img src="https://ow.mapleqaq.top/hero/${encodeURIComponent(heroKey)}.png" alt="${heroKey}" loading="lazy">`;
                            heroesContainer.appendChild(heroEl);
                        });
                    }

                    // === æ®µä½æ˜¾ç¤ºé€»è¾‘ ===
                    let rankElement = '';
                    if (user.Rank && user.Rank.rank && typeof user.Rank.level === 'number') {
                        const validRanks = ['silver', 'gold', 'diamond', 'master', 'grandmaster'];
                        if (validRanks.includes(user.Rank.rank) && user.Rank.level >= 1 && user.Rank.level <= 5) {
                            rankElement = `
            <div class="member-rank">
                <img src="./imge/rank/${user.Rank.rank}.png" alt="${user.Rank.rank}" />
                <span class="rank-level">${user.Rank.level}</span>
            </div>
        `;
                        }
                    }

                    // å°†æ®µä½å…ƒç´ æ’å…¥åˆ° card çš„é¡¶éƒ¨ï¼ˆåœ¨ header å’Œ heroesContainer ä¹‹ä¸Šï¼‰
                    if (rankElement) {
                        attachRankToLikeButton(card, rankElement);
                    }
                    card.appendChild(header);
                    card.appendChild(heroesContainer);
                    const likeListPlaceholder = document.createElement('div');
                    likeListPlaceholder.className = 'like-list';
                    likeListPlaceholder.style.display = 'none';
                    card.appendChild(likeListPlaceholder);
                    grid.appendChild(card);

                    // æ­¤æ—¶ likeCache å·²æœ‰æ•°æ®ï¼Œå¯æ­£ç¡®æ˜¾ç¤ºæ€»èµæ•°
                    renderLikeButton(card, user.username);


                }

                if (finalUsers.length === 0) {
                    grid.innerHTML = '<p style="text-align:center;color:var(--accent);">ğŸ“­ æš‚æ— æˆå‘˜</p>';
                }
            } catch (err) {
                console.error('åŠ è½½æˆå‘˜åå•å¤±è´¥:', err);
                const grid = document.getElementById('membersGrid');
                if (grid) {
                    grid.innerHTML = '<p style="text-align:center;color:var(--accent);">âš ï¸ æ— æ³•åŠ è½½æˆå‘˜åå•</p>';
                }
            }


        }

        /**
 * å°†æ®µä½å›¾æ ‡æ­£ç¡®è´´åˆåˆ°ç‚¹èµæŒ‰é’®å·¦ä¾§ï¼ˆå“åº”å¼ã€ä¸éšå±å¹•æŠ–åŠ¨ï¼‰
 * @param {HTMLElement} card - æˆå‘˜å¡ç‰‡ DOM å…ƒç´ 
 * @param {string} rankElementHTML - æ®µä½ HTML å­—ç¬¦ä¸²ï¼ˆå¦‚ '<div class="member-rank">...</div>'ï¼‰
 */
        function attachRankToLikeButton(card, rankElementHTML) {
            // è·å–æˆ–åˆ›å»ºå®¹å™¨
            let likeContainer = card.querySelector('.like-button-container');
            if (!likeContainer) {
                likeContainer = document.createElement('div');
                likeContainer.className = 'like-button-container';
                Object.assign(likeContainer.style, {
                    position: 'absolute',
                    top: '8px',
                    right: '8px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px', // å‡å°é—´è·
                    zIndex: '10',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    textShadow: '0 0 3px rgba(0,0,0,0.7)',
                    cursor: 'pointer'
                });
                card.style.position = 'relative';
                card.appendChild(likeContainer);
            }

            // æ¸…ç©ºå®¹å™¨ï¼Œé‡æ–°æ„å»ºï¼ˆé¿å…é‡å¤æ’å…¥ï¼‰
            likeContainer.innerHTML = '';

            // 1. æ·»åŠ æ®µä½å›¾æ ‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if (rankElementHTML) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = rankElementHTML.trim();
                const rankEl = tempDiv.firstElementChild;
                if (rankEl) {
                    rankEl.style.position = 'relative';
                    rankEl.style.width = '24px';   // ğŸ‘ˆ ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œæ›´ç´§å‡‘
                    rankEl.style.height = '24px';

                    const levelSpan = rankEl.querySelector('.rank-level');
                    if (levelSpan) {
                        Object.assign(levelSpan.style, {
                            position: 'absolute',
                            bottom: '1px',
                            right: '1px',
                            fontSize: '9px',
                            fontWeight: 'bold',
                            color: '#fff',
                            backgroundColor: 'rgba(0,0,0,0.6)',
                            borderRadius: '2px',
                            padding: '0 1px',
                            lineHeight: '1',
                            zIndex: '2'
                        });
                    }
                    likeContainer.appendChild(rankEl);
                }
            }

            // 2. æ·»åŠ ç‚¹èµæ•°å­—
            const countSpan = document.createElement('span');
            countSpan.className = 'like-count';
            countSpan.style.color = '#ffffff';
            countSpan.textContent = '0';
            likeContainer.appendChild(countSpan);

            // 3. æ·»åŠ å¿ƒå½¢å›¾æ ‡
            const heartIcon = document.createElement('span');
            heartIcon.innerHTML = 'â¤ï¸';
            heartIcon.style.color = '#ff4d6d';
            likeContainer.appendChild(heartIcon);

            // 4. ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
            if (!likeContainer.hasClickHandler) {
                likeContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isSelf = card.hasAttribute('data-is-self');
                    const username = card.querySelector('.member-id')?.textContent;
                    if (username) {
                        handleLikeClick(card, username, isSelf);
                    }
                });
                likeContainer.hasClickHandler = true;
            }
        }

        // ç¤ºä¾‹ï¼šå½“ç”¨æˆ·ç‚¹å‡»æŸä¸ªç”¨æˆ·çš„ç‚¹èµæŒ‰é’®æ—¶
        function onLikeButtonClick(targetUser, card) {
            const self = getCookie('auth')?.battletag;
            if (!self || targetUser === self) return;

            // 1. å¢åŠ ä¸´æ—¶ UI å¢é‡
            const currentTemp = tempLikeIncrements.get(targetUser) || 0;
            tempLikeIncrements.set(targetUser, currentTemp + 1);

            // 2. ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼ˆçœ‹èµ·æ¥ç‚¹äº†å°±+1ï¼‰
            updateTotalLikeDisplay(card, targetUser);

            // 3. åŠ å…¥å¾…æäº¤é˜Ÿåˆ—ï¼ˆä½ åŸæœ‰çš„ pendingLikes é€»è¾‘ï¼‰
            const currentPending = pendingLikes.get(targetUser) || 0;
            pendingLikes.set(targetUser, currentPending + 1);

            // 4. è§¦å‘å»¶è¿Ÿæäº¤ï¼ˆå¦‚ 3 ç§’åï¼‰
            clearTimeout(likeTimeouts.get(targetUser));
            likeTimeouts.set(targetUser, setTimeout(() => submitLikes(targetUser), 3000));
        }

        // ========== å¯åŠ¨æµç¨‹ ==========
        document.addEventListener('DOMContentLoaded', async function () {
            const isValid = await verifyAuth();
            if (isValid) {
                initPage();
            }
        });


    </script>


    </div> <!-- è¿™æ˜¯ #joinPlayContainer çš„é—­åˆæ ‡ç­¾ -->

    <!-- âœ… å†æ”¾åº•éƒ¨å¯¼èˆªæ  -->
    <div class="fixed-bottom-nav">
        <a href="/news.html" class="nav-tab">
            <div>é»‘çˆªåŠ¨æ€</div>
        </a>
        <a href="./main.html" class="nav-tab active">
            <div>ä¸»é¡µ</div>
        </a>
        <a href="./profile.html" class="nav-tab">
            <div>æˆ‘çš„</div>
        </a>
    </div>

</body>

</html>
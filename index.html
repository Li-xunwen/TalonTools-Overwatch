<!DOCTYPE html>
<html lang="zh-CN" id="htmlRoot">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç™»å½• Â· é»‘çˆªç‰¹å·¥</title>
    <link rel="stylesheet" href="styles/index.css">
</head>

<body>
    <button class="theme-toggle" id="themeToggle">ğŸŒ™</button>

    <div class="login-container">
        <h2>æ¬¢è¿å›æ¥,é»‘çˆªç‰¹å·¥</h2>
        <form id="loginForm">
            <input type="text" id="battletagInput" class="input-field" placeholder="æˆ˜ç½‘ID" required />
            <datalist id="userSuggestions"></datalist>

            <input type="password" id="passwordInput" class="input-field" placeholder="å¯†ç " required />

            <div class="error-message" id="errorMessage"></div>

            <a href="#" class="forgot-password">å¿˜è®°å¯†ç ï¼Ÿ</a>
            <button type="submit" class="login-btn">ç™»å½•</button>
        </form>
    </div>

<script>
  // ========== ä¸»é¢˜åˆ‡æ¢ ==========
  const html = document.getElementById('htmlRoot');
  const themeToggle = document.getElementById('themeToggle');
  const useDark = localStorage.getItem('theme') === 'dark' || localStorage.getItem('theme') === null;

  function applyTheme(isDark) {
    if (isDark) {
      html.classList.add('dark-theme');
      themeToggle.textContent = 'â˜€ï¸';
      localStorage.setItem('theme', 'dark');
    } else {
      html.classList.remove('dark-theme');
      themeToggle.textContent = 'ğŸŒ™';
      localStorage.setItem('theme', 'light');
    }
  }
  applyTheme(useDark);
  themeToggle.addEventListener('click', () => {
    const isCurrentlyDark = html.classList.contains('dark-theme');
    applyTheme(!isCurrentlyDark);
  });

  // ========== å…¨å±€å˜é‡ ==========
  let validUsernames = []; // ç”¨äºå¿«é€Ÿæ ¡éªŒIDæ˜¯å¦å­˜åœ¨
  const battletagInput = document.getElementById('battletagInput');
  const passwordInput = document.getElementById('passwordInput');
  const errorMessage = document.getElementById('errorMessage');
  const loginForm = document.getElementById('loginForm');
  const datalist = document.getElementById('userSuggestions');

  // ========== å·¥å…·å‡½æ•° ==========
  function sha256(str) {
    const encoder = new TextEncoder();
    return crypto.subtle.digest('SHA-256', encoder.encode(str)).then(hash => {
      return Array.from(new Uint8Array(hash))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('')
        .toUpperCase();
    });
  }

  function setAuthCookie(data, days = 7) {
    const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString();
    document.cookie = `auth=${encodeURIComponent(JSON.stringify(data))}; expires=${expires}; path=/; SameSite=Lax`;
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
      try {
        return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
      } catch (e) {
        return null;
      }
    }
    return null;
  }

  // ========== è‡ªåŠ¨ç™»å½•æ£€æµ‹ ==========
  (async () => {
    const auth = getCookie('auth');
    if (auth && auth.battletag && auth.passwordHash) {
      // å¯é€‰ï¼šæ˜¾ç¤ºæç¤º
      document.querySelector('.login-container h2').textContent = 'è‡ªåŠ¨ç™»å½•ä¸­...';
      document.querySelector('.login-container').style.opacity = '0.6';
      // çŸ­æš‚å»¶è¿Ÿåè·³è½¬ï¼ˆæå‡ä½“éªŒï¼‰
      setTimeout(() => {
        window.location.href = './main.html';
      }, 800);
      return; // é˜»æ­¢åç»­åˆå§‹åŒ–ï¼ˆå¦‚åŠ è½½ç”¨æˆ·åˆ—è¡¨ç­‰éå¿…éœ€æ“ä½œï¼‰
    }

    // å¦‚æœæ²¡æœ‰è‡ªåŠ¨ç™»å½•ï¼Œåˆ™ç»§ç»­åˆå§‹åŒ–è¡¨å•
    await initLoginForm();
  })();

  async function initLoginForm() {
    // åŠ è½½ç”¨æˆ·ååˆ—è¡¨ï¼ˆé˜²ç¼“å­˜ï¼‰
    try {
      const res = await fetch('https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/user.json?t=' + Date.now(), { cache: 'no-store' });
      if (res.ok) {
        validUsernames = await res.json();
        if (Array.isArray(validUsernames)) {
          datalist.innerHTML = '';
          validUsernames.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            datalist.appendChild(opt);
          });
          toggleDatalist(battletagInput.value.trim());
        }
      }
    } catch (err) {
      console.warn('ç”¨æˆ·åˆ—è¡¨åŠ è½½å¤±è´¥:', err);
    }

    // ç»‘å®šè¾“å…¥äº‹ä»¶
    function toggleDatalist(value) {
      if (value === '') {
        battletagInput.removeAttribute('list');
      } else {
        battletagInput.setAttribute('list', 'userSuggestions');
      }
    }
    battletagInput.addEventListener('input', e => toggleDatalist(e.target.value.trim()));
    battletagInput.addEventListener('focus', () => {
      if (battletagInput.value.trim() !== '') {
        battletagInput.setAttribute('list', 'userSuggestions');
      }
    });

    // ç»‘å®šè¡¨å•æäº¤
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMessage.textContent = '';

      const battletag = battletagInput.value.trim();
      const password = passwordInput.value;

      if (!battletag || !password) {
        errorMessage.textContent = 'è¯·è¾“å…¥æˆ˜ç½‘IDå’Œå¯†ç ';
        return;
      }

      // âœ… ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æˆ˜ç½‘IDæ˜¯å¦å­˜åœ¨
      if (!validUsernames.includes(battletag)) {
        errorMessage.textContent = 'æˆ˜ç½‘ID ä¸å­˜åœ¨';
        return;
      }

      try {
        // è®¡ç®—å¯†ç å“ˆå¸Œ
        const hash = await sha256(password);
        const hashPrefix16 = hash.substring(0, 16);

        // è¯·æ±‚ç”¨æˆ·æ•°æ®
        const encodedTag = encodeURIComponent(battletag);
        const userUrl = `https://talon-admin-1258609989.cos.ap-chongqing.myqcloud.com/${encodedTag}/${encodedTag}.json?t=${Date.now()}`;
        const userRes = await fetch(userUrl, { cache: 'no-store' });

        if (!userRes.ok) {
          errorMessage.textContent = 'ç”¨æˆ·æ•°æ®åŠ è½½å¤±è´¥';
          return;
        }

        const userData = await userRes.json();
        const serverPwd16 = (userData.PWD16Byte || '').toUpperCase();

        if (hashPrefix16 === serverPwd16) {
          // ç™»å½•æˆåŠŸ
          setAuthCookie({ battletag, passwordHash: hash });
          window.location.href = './main.html';
        } else {
          errorMessage.textContent = 'å¯†ç é”™è¯¯';
        }
      } catch (err) {
        console.error(err);
        errorMessage.textContent = 'ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯';
      }
    });
  }
</script>
</body>

</html>